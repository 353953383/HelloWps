<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆªç§‘GPT V1</title>
    <!-- WPS API åŠ è½½ -->
    <!-- æœ¬åœ°WPS APIåŠ è½½è„šæœ¬ -->
    <script type="text/javascript" src="../../js/wpsLoad.js"></script>
    <!-- åŠ è½½æœåŠ¡å™¨é…ç½® -->
    <script type="text/javascript" src="../../js/load-config.js"></script>
    
    <!-- AI Helper ç›¸å…³è„šæœ¬ï¼Œç”¨äºå¤„ç†APIè¯·æ±‚ -->
    <script type="text/javascript" src="../../js/aiHelper/api-config.js"></script>
    <script type="text/javascript" src="../../js/aiHelper/aiInterface.js"></script>
    <script type="text/javascript" src="../../js/aiHelper/enhanced-ai-interface.js"></script>
    <style>
        
        
        body {
              font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: #050a16;
            color: #e0f2fe;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* ç§‘æŠ€é£å‡ ä½•çº¿æ¡èƒŒæ™¯ */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(6, 182, 212, 0.3) 0%, transparent 60%),
                radial-gradient(circle at 75% 75%, rgba(168, 85, 247, 0.3) 0%, transparent 60%);
            z-index: -1;
            transform: translateZ(0);
        }
        
        /* åŠ¨æ€å‡ ä½•çº¿æ¡å®¹å™¨ */
        .geometric-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        /* å‡ ä½•çº¿æ¡ - ä½¿ç”¨SVGæ¨¡å¼ */
        .line-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(6, 182, 212, 0.4) 1px, transparent 1px),
                linear-gradient(90deg, rgba(6, 182, 212, 0.4) 1px, transparent 1px);
            background-size: 15px 15px;
            animation: gridMove 10s linear infinite;
            opacity: 0.8;
            z-index: 1;
            will-change: transform;
            transform: translateZ(0);
        }
        
        @keyframes gridMove {
            0% {
                transform: translate(0, 0);
            }
            50% {
                transform: translate(-12.5%, -12.5%);
            }
            100% {
                transform: translate(0, 0);
            }
        }
        
        /* åŠ¨æ€å‡ ä½•çº¿æ¡å˜æ¢ */
        .dynamic-lines {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.5;
            z-index: 2;
        }
        
        .dynamic-lines::before, .dynamic-lines::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-size: 100px 100px;
        }
        
        .dynamic-lines::before {
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(168, 85, 247, 0.7) 4px, rgba(168, 85, 247, 0.7) 6px);
            animation: rotatePattern 20s linear infinite;
            will-change: transform;
            transform: translateZ(0);
        }
        
        .dynamic-lines::after {
            background-image: 
                repeating-linear-gradient(90deg, transparent, transparent 6px, rgba(6, 182, 212, 0.7) 6px, rgba(6, 182, 212, 0.7) 8px);
            animation: rotatePattern 25s linear infinite reverse;
            will-change: transform;
            transform: translateZ(0);
        }
        
        @keyframes rotatePattern {
            0% {
                transform: rotate(0deg) scale(1);
            }
            100% {
                transform: rotate(360deg) scale(1);
            }
        }
        
        /* å‡ ä½•å½¢çŠ¶åŠ¨ç”» */
        .geometric-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 2;
        }
        
        .shape {
            position: absolute;
            background: transparent;
            border: 1px solid rgba(6, 182, 212, 0.5);
            animation: float 15s infinite ease-in-out;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.2);
            transform-origin: center;
            z-index: 1;
            will-change: transform;
            transform: translateZ(0);
        }
        
        .shape:nth-child(1) {
            width: 120px;
            height: 120px;
            top: 15%;
            left: 15%;
            border-radius: 0%;
            transform: rotate(45deg);
            animation-delay: 0s;
        }
        
        .shape:nth-child(2) {
            width: 150px;
            height: 50px;
            top: 65%;
            left: 65%;
            border-radius: 0%;
            transform: rotate(30deg);
            animation-delay: -5s;
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
        }
        
        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(20px, -20px) rotate(5deg);
            }
            50% {
                transform: translate(0, 20px) rotate(10deg);
            }
            75% {
                transform: translate(-20px, -10px) rotate(-5deg);
            }
        }
        
        .chat-container {
            width: 90%;
            max-width: 700px;
            height: 90vh;
            max-height: 90vh;
            background: rgba(15, 23, 42, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                0 0 20px rgba(6, 182, 212, 0.2),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            overflow: hidden;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }
        
        /* å‘å…‰è¾¹æ¡†æ•ˆæœ */
        .chat-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #06b6d4, #a855f7, #06b6d4);
            z-index: -1;
            border-radius: 14px;
            background-size: 400%;
            animation: glowing 20s linear infinite;
            opacity: 0.5;
        }
        
        @keyframes glowing {
            0% { background-position: 0 0; }
            50% { background-position: 400% 0; }
            100% { background-position: 0 0; }
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(15, 23, 42, 0.3);
            padding: 12px 16px;
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
            backdrop-filter: blur(5px);
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
        }
        
        .chat-header-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(45deg, #06b6d4, #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
            letter-spacing: 0.5px;
        }
        
        .reset-button,
        .test-wps-button {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(168, 85, 247, 0.2));
            color: #e0f2fe;
            border: 1px solid rgba(6, 182, 212, 0.5);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            letter-spacing: 1px;
        }
        
        /* ç§»é™¤æµ‹è¯•WPSè¿æ¥æŒ‰é’®ç›¸å…³æ ·å¼ */
        
        .reset-button:hover {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.3), rgba(168, 85, 247, 0.3));
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
            transform: translateY(-1px);
        }
        
        .chat-body {
            height: calc(100% - 130px);
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: rgba(6, 182, 212, 0.5) rgba(15, 23, 42, 0.3);
            margin-bottom: 10px;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .chat-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-body::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 3px;
        }
        
        .chat-body::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, rgba(6, 182, 212, 0.5), rgba(168, 85, 247, 0.5));
            border-radius: 3px;
        }
        
        .message {
            margin-bottom: 16px;
            padding: 10px 16px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            background: rgba(15, 23, 42, 0.3);
        }
        
        .message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            opacity: 0.1;
            transition: opacity 0.3s ease;
        }
        
        .user-message {
            background: linear-gradient(135deg, rgba(29, 78, 216, 0.3), rgba(37, 99, 235, 0.3));
            color: #e0f2fe;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .user-message::before {
            background: radial-gradient(circle, rgba(6, 182, 212, 0.5) 0%, transparent 70%);
        }
        
        .user-message:hover::before {
            opacity: 0.2;
        }
        
        .ai-message {
            background: linear-gradient(135deg, rgba(12, 74, 110, 0.3), rgba(8, 47, 73, 0.3));
            color: #e0f2fe;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border-left: 3px solid #06b6d4;
        }
        
        .ai-message::before {
            background: radial-gradient(circle, rgba(168, 85, 247, 0.5) 0%, transparent 70%);
        }
        
        .ai-message:hover::before {
            opacity: 0.2;
        }
        
        .thinking {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.3), rgba(15, 23, 42, 0.3));
            color: #e2e8f0;
            padding: 10px 16px;
            border-radius: 18px;
            margin-bottom: 16px;
            max-width: 75%;
            word-wrap: break-word;
            align-self: flex-start;
            border-left: 3px solid #a855f7;
            position: relative;
            overflow: hidden;
        }
        
        .thinking::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 48%, rgba(168, 85, 247, 0.1) 50%, transparent 52%);
            background-size: 10px 10px;
            animation: thinkingPattern 20s linear infinite;
            z-index: -1;
        }
        
        @keyframes thinkingPattern {
            0% { background-position: 0 0; }
            100% { background-position: 100px 100px; }
        }
        
        .thinking-header {
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Orbitron', sans-serif;
            color: #a855f7;
            letter-spacing: 0.5px;
        }
        
        .thinking-content {
            margin-top: 8px;
            display: none;
            padding-top: 8px;
            border-top: 1px solid rgba(168, 85, 247, 0.2);
            color: #cbd5e1;
        }
        
        .chat-footer {
            position: relative;
            background: rgba(15, 23, 42, 0.3);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            border-top: 1px solid rgba(6, 182, 212, 0.2);
            flex-shrink: 0;
        }
        
        .input-field {
            flex-grow: 1;
            background: rgba(15, 23, 42, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 20px;
            padding: 12px 16px;
            margin-right: 12px;
            color: #e0f2fe;
            font-family: 'Roboto', sans-serif;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
            background: rgba(15, 23, 42, 0.4);
        }
        
        .input-field::placeholder {
            color: rgba(186, 230, 253, 0.5);
        }
        
        /* å¼•ç”¨æ–‡ä»¶æ—¶çš„ç‰¹æ®Šplaceholderæ ·å¼ */
        .input-field.referenced::placeholder {
            color: #22c55e; /* ç»¿è‰²æ˜¾ç¤ºå¼•ç”¨æ ‡è®° */
            font-weight: 500;
        }
        
        .send-icon, .stop-icon, .upload-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .send-icon, .upload-icon {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.3), rgba(168, 85, 247, 0.3));
            color: #e0f2fe;
            border: 1px solid rgba(6, 182, 212, 0.5);
        }
        
        .upload-icon:hover {
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.6);
            transform: scale(1.1);
        }
        
        .upload-icon:hover .icon {
            transform: scale(1.2);
        }
        
        /* ä¸Šä¼ æŒ‰é’®å‘å…‰æ•ˆæœ */
        .upload-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.5;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s, opacity 0.5s;
        }
        
        .upload-icon:active::after {
            width: 100px;
            height: 100px;
            opacity: 0;
        }
        
        .send-icon:hover {
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.6);
            transform: scale(1.1);
        }
        
        .stop-icon {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.3));
            color: #fecaca;
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        
        .stop-icon:hover {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            transform: scale(1.1);
        }
        
        .icon {
            font-size: 16px;
            transition: transform 0.2s ease;
        }
        
        .send-icon:hover .icon {
            transform: scale(1.2);
        }
        
        /* æŒ‰é’®å‘å…‰æ•ˆæœ */
        .send-icon::after, .stop-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.5;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s, opacity 0.5s;
        }
        
        .send-icon:active::after, .stop-icon:active::after {
            width: 100px;
            height: 100px;
            opacity: 0;
        }
        
        /* å·¥ä½œç°¿é€‰æ‹©ä¸‹æ‹‰æ¡†æ ·å¼ */
        .workbook-dropdown {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(6, 182, 212, 0.5);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(6, 182, 212, 0.3);
            backdrop-filter: blur(10px);
            max-width: 300px;
            min-width: 250px;
            z-index: 1000;
            animation: dropdownSlideIn 0.3s ease-out;
        }
        
        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
        }
        
        .workbook-select-header {
            padding: 12px 16px 8px 16px;
            color: #06b6d4;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
        }
        
        .workbook-options {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
        }
        
        .workbook-options::-webkit-scrollbar {
            width: 6px;
        }
        
        .workbook-options::-webkit-scrollbar-track {
            background: rgba(6, 182, 212, 0.1);
            border-radius: 3px;
        }
        
        .workbook-options::-webkit-scrollbar-thumb {
            background: rgba(6, 182, 212, 0.6);
            border-radius: 3px;
        }
        
        .workbook-options::-webkit-scrollbar-thumb:hover {
            background: rgba(6, 182, 212, 0.8);
        }
        
        .workbook-option {
            padding: 10px 12px;
            margin: 2px 0;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #e0f2fe;
            font-size: 14px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .workbook-option:hover {
            background: rgba(6, 182, 212, 0.2);
            border-color: rgba(6, 182, 212, 0.6);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
        }
        
        .workbook-option:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
        }
        
        /* å‘½ä»¤é€‰æ‹©ä¸‹æ‹‰æ¡†æ ·å¼ */
        .command-dropdown {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(168, 85, 247, 0.5);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(168, 85, 247, 0.3);
            backdrop-filter: blur(10px);
            max-width: 320px;
            min-width: 280px;
            z-index: 1001;
            animation: dropdownSlideIn 0.3s ease-out;
        }
        
        .command-select-header {
            padding: 12px 16px 8px 16px;
            color: #a855f7;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid rgba(168, 85, 247, 0.2);
        }
        
        .command-options {
            max-height: 250px;
            overflow-y: auto;
            padding: 8px;
        }
        
        .command-options::-webkit-scrollbar {
            width: 6px;
        }
        
        .command-options::-webkit-scrollbar-track {
            background: rgba(168, 85, 247, 0.1);
            border-radius: 3px;
        }
        
        .command-options::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.6);
            border-radius: 3px;
        }
        
        .command-options::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 85, 247, 0.8);
        }
        
        .command-option {
            padding: 10px 12px;
            margin: 2px 0;
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #e0f2fe;
            font-size: 14px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .command-option:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.6);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.2);
        }
        
        .command-option:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
        }
        
        .command-description {
            font-size: 12px;
            color: rgba(224, 242, 254, 0.7);
            margin-top: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* ç§‘æŠ€æ„ŸåŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            position: relative;
            width: 20px;
            height: 20px;
        }
        
        .loading div {
            position: absolute;
            top: 3px;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: #06b6d4;
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }
        
        .loading div:nth-child(1) {
            left: 3px;
            animation: loading1 0.6s infinite;
        }
        
        .loading div:nth-child(2) {
            left: 3px;
            animation: loading2 0.6s infinite;
        }
        
        .loading div:nth-child(3) {
            left: 10px;
            animation: loading2 0.6s infinite;
        }
        
        .loading div:nth-child(4) {
            left: 17px;
            animation: loading3 0.6s infinite;
        }
        
        @keyframes loading1 {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        
        @keyframes loading3 {
            0% { transform: scale(1); }
            100% { transform: scale(0); }
        }
        
        @keyframes loading2 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(7px, 0); }
        }
        
        /* ç§»é™¤è°ƒè¯•ä¿¡æ¯æ ·å¼ */
        
        /* å¸®åŠ©è¯´æ˜æ ·å¼ */
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .new-conversation-btn {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(168, 85, 247, 0.2));
            color: #e0f2fe;
            border: 1px solid rgba(6, 182, 212, 0.5);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .new-conversation-btn:hover {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.3), rgba(168, 85, 247, 0.3));
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
            transform: scale(1.1);
        }
        
        .new-conversation-btn:active {
            transform: scale(0.95);
        }
        
        .help-toggle-button {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(168, 85, 247, 0.2));
            color: #e0f2fe;
            border: 1px solid rgba(6, 182, 212, 0.5);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .help-toggle-button:hover {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.3), rgba(168, 85, 247, 0.3));
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
            transform: scale(1.1);
        }
        
        .help-section {
            background: rgba(15, 23, 42, 0.4);
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .help-section.show {
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .help-content {
            color: #e0f2fe;
            max-height: 268px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .help-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .help-content::-webkit-scrollbar-track {
            background: rgba(6, 182, 212, 0.1);
            border-radius: 3px;
        }
        
        .help-content::-webkit-scrollbar-thumb {
            background: rgba(6, 182, 212, 0.6);
            border-radius: 3px;
        }
        
        .help-content::-webkit-scrollbar-thumb:hover {
            background: rgba(6, 182, 212, 0.8);
        }
        
        .help-content h3 {
            margin-top: 0;
            color: #06b6d4;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
        }
        
        .help-content ul {
            margin: 0;
            padding-left: 20px;
            line-height: 1.6;
        }
        
        .help-content li {
            margin-bottom: 6px;
        }
        
        /* å¯Œæ–‡æœ¬è¾“å…¥åŒºåŸŸå®¹å™¨æ ·å¼ */
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }
        
        /* å·¥ä½œç°¿å¼•ç”¨æ ‡ç­¾å®¹å™¨æ ·å¼ */
        .workbook-reference-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.4);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 12px;
            color: #86efac;
            font-family: 'Orbitron', sans-serif;
            backdrop-filter: blur(5px);
        }
        
        .workbook-reference-label {
            font-weight: 600;
            color: #22c55e;
        }
        
        .workbook-reference-name {
            flex-grow: 1;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .remove-reference-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: bold;
        }
        
        .remove-reference-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.6);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
            transform: scale(1.1);
        }
        
        /* æ ¼å¼åŒ–å·¥å…·æ æ ·å¼ */
        .format-toolbar {
            display: none;
            align-items: center;
            gap: 4px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 8px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .format-toolbar.show {
            display: flex;
        }
        
        /* æ ¼å¼åŒ–æŒ‰é’®æ ·å¼ */
        .format-btn {
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #67e8f9;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 600;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .format-btn:hover {
            background: rgba(6, 182, 212, 0.25);
            border-color: rgba(6, 182, 212, 0.5);
            box-shadow: 0 0 12px rgba(6, 182, 212, 0.3);
            transform: translateY(-1px);
        }
        
        .format-btn:active {
            transform: translateY(0);
            box-shadow: 0 0 8px rgba(6, 182, 212, 0.4);
        }
        
        /* å¯Œæ–‡æœ¬è¾“å…¥æ¡†æ ·å¼ - å…¨å®½è®¾è®¡ï¼Œé›¶è¾¹è· */
        .rich-input-field {
            width: 100%;
            background: rgba(15, 23, 42, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px;
            padding: 12px 0px 50px 0px; /* çœŸæ­£å…¨å®½ï¼Œé›¶è¾¹è· */
            color: #e0f2fe;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            transition: all 0.3s ease;
            resize: none;
            overflow-y: hidden;
            backdrop-filter: blur(5px);
            min-height: 48px;
            max-height: 200px;
            position: relative;
        }
        
        .rich-input-field:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
            background: rgba(15, 23, 42, 0.3);
        }
        
        .rich-input-field::placeholder {
            color: rgba(186, 230, 253, 0.5);
            font-style: italic;
        }
        
        /* å¼•ç”¨æ–‡ä»¶æ—¶çš„ç‰¹æ®Šæ ·å¼ */
        .rich-input-field.referenced::placeholder {
            color: #22c55e;
            font-weight: 500;
            font-style: normal;
        }
        
        /* æ“ä½œæŒ‰é’®åŒºåŸŸæ ·å¼ - å³ä¸‹è§’å®šä½ */
        .action-buttons {
            position: absolute;
            bottom: 8px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
        }
        
        /* æ¸…ç©ºèŠå¤©æŒ‰é’®æ ·å¼ */
        .clear-chat-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        
        .clear-chat-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.6);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            transform: scale(1.1);
        }
        
        .clear-chat-btn:hover .icon {
            transform: scale(1.2);
        }
        
        /* æŒ‰é’®å‘å…‰æ•ˆæœ */
        .clear-chat-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.5;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s, opacity 0.5s;
        }
        
        .clear-chat-btn:active::after {
            width: 100px;
            height: 100px;
            opacity: 0;
        }
    </style>
</head>
<body>
    <!-- ç§‘æŠ€é£å‡ ä½•çº¿æ¡èƒŒæ™¯å®¹å™¨ -->
    <div class="geometric-background">
        <div class="line-grid"></div>
        <div class="dynamic-lines"></div>
        <div class="geometric-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
    </div>
    
    <!-- ç§»é™¤WPSçŠ¶æ€æ˜¾ç¤ºå®¹å™¨ -->

    <div class="chat-container">
        <div class="chat-header">
            <div class="header-left">
                <div class="chat-header-title">èˆªç§‘GPT V1</div>
                <button id="helpToggle" class="help-toggle-button" onclick="toggleHelp()">?</button>
            </div>
            <div class="header-right">
                <button class="new-conversation-btn" id="newConversationButton" onclick="clearChatHistory()" title="æ–°å¯¹è¯">
                    <span class="icon">+</span>
                </button>
            </div>
        </div>
        <div id="helpSection" class="help-section">
            <div class="help-content">
                <h3>ä½¿ç”¨è¯´æ˜</h3>
                <ul>
                    <li>åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ŒæŒ‰Enteræˆ–ç‚¹å‡»å‘é€æŒ‰é’®</li>
                    <li>ç³»ç»Ÿå°†è‡ªåŠ¨è¿æ¥åˆ°WPSè¡¨æ ¼ç¯å¢ƒå¹¶å¤„ç†æ‚¨çš„è¯·æ±‚</li>
                    <li>ç‚¹å‡»"æ–°å¯¹è¯"æŒ‰é’®å¯ä»¥æ¸…é™¤å½“å‰èŠå¤©è®°å½•</li>
                    <li>ç‚¹å‡»æ–‡ä»¶ä¸Šä¼ æŒ‰é’®ğŸ“å¯ä»¥ä¸Šä¼ æ–‡ä»¶(txtã€pdfã€docã€docxã€csvã€ofdã€xlsã€xlsxã€xlsm)è¿›è¡Œembeddingsç”Ÿæˆ</li>
                    <li>æ”¯æŒçš„å‘½ä»¤ï¼š</li>
                    <li>/å¼•ç”¨æ–‡ä»¶ - å¼•ç”¨å·¥ä½œç°¿ï¼Œå°†å·¥ä½œç°¿ä½œä¸ºé™„ä»¶ä¸Šä¼ åˆ°AIèŠå¤©å¤§æ¨¡å‹ã€‚</li>
                    <li>/å†™å…¥æ–‡æ¡£ [å†…å®¹] - å‘å½“å‰WPSæ–‡æ¡£å†™å…¥å†…å®¹</li>
                    <li>/æ¸…ç©ºæ–‡æ¡£ - æ¸…ç©ºå½“å‰WPSæ–‡æ¡£å†…å®¹</li>
                    <li>/help - æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯</li>
                    <li>/models æˆ– /æ¨¡å‹ - è·å–å¯ç”¨çš„AIæ¨¡å‹åˆ—è¡¨</li>
                    <li>ä»¥!completion æˆ– !è¡¥å…¨å¼€å¤´ - ä½¿ç”¨completions APIè€Œéchat completions</li>
                </ul>
            </div>
        </div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-footer">
            <!-- å·¥ä½œç°¿é€‰æ‹©ä¸‹æ‹‰æ¡† -->
            <div id="workbookSelectDropdown" class="workbook-dropdown" style="display: none;">
                <div class="workbook-select-header">é€‰æ‹©è¦å¼•ç”¨çš„å·¥ä½œç°¿ï¼š</div>
                <div id="workbookOptions" class="workbook-options"></div>
            </div>
            
            <!-- å‘½ä»¤é€‰æ‹©ä¸‹æ‹‰æ¡† -->
            <div id="commandDropdown" class="command-dropdown" style="display: none;">
                <div class="command-select-header">é€‰æ‹©è¦ä½¿ç”¨çš„å‘½ä»¤ï¼š</div>
                <div id="commandOptions" class="command-options"></div>
            </div>
            
            <!-- å¯Œæ–‡æœ¬è¾“å…¥åŒºåŸŸ - å…¨å®½å¸ƒå±€ -->
            <div class="input-container">
                <!-- å·¥ä½œç°¿å¼•ç”¨æ ‡ç­¾å®¹å™¨ -->
                <div id="workbookReferenceContainer" class="workbook-reference-container" style="display: none;">
                    <span class="workbook-reference-label">å·²å¼•ç”¨ï¼š</span>
                    <span id="referencedWorkbookName" class="workbook-reference-name"></span>
                    <button class="remove-reference-btn" onclick="removeWorkbookReference()">Ã—</button>
                </div>
                
                <!-- æ ¼å¼åŒ–å·¥å…·æ  -->
                <div class="format-toolbar" style="display: none;">
                    <button class="format-btn" onclick="formatText('bold')" title="ç²—ä½“">B</button>
                    <button class="format-btn" onclick="formatText('italic')" title="æ–œä½“"><i>I</i></button>
                    <button class="format-btn" onclick="formatText('underline')" title="ä¸‹åˆ’çº¿"><u>U</u></button>
                    <button class="format-btn" onclick="formatText('strike')" title="åˆ é™¤çº¿"><s>S</s></button>
                    <button class="format-btn" onclick="formatText('code')" title="ä»£ç ">`</button>
                </div>
                
                <!-- å¯Œæ–‡æœ¬è¾“å…¥æ¡†å®¹å™¨ -->
                <div style="position: relative;">
                    <!-- å¯Œæ–‡æœ¬è¾“å…¥æ¡† -->
                    <textarea class="rich-input-field" id="userInput" placeholder="è¾“å…¥é—®é¢˜ï¼ŒAIå°†ä¸ºæ‚¨è§£ç­”...ï¼ˆCtrl+Enteræ¢è¡Œï¼‰" rows="3" onkeydown="handleKeyPress(event)" oninput="monitorInput()"></textarea>
                    
                    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ - å³ä¸‹è§’å®šä½ -->
                    <div class="action-buttons">
                        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                        <input type="file" id="fileUpload" style="display: none;" accept=".txt,.pdf,.doc,.docx,.csv,.ofd,.xls,.xlsx,.xlsm" onchange="handleFileUpload(this.files)">
                        
                        <!-- åŠŸèƒ½æŒ‰é’® -->
                        <button class="upload-icon" id="uploadButton" onclick="document.getElementById('fileUpload').click()" title="ä¸Šä¼ æ–‡ä»¶">
                            <span class="icon">ğŸ“</span>
                        </button>
                        
                        <button class="send-icon" id="sendButton" onclick="sendMessage()" title="å‘é€æ¶ˆæ¯">
                            <span class="icon">â†’</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨embeddingsç»“æœå’Œå®æ—¶é€‰æ‹©çŠ¶æ€
        let currentEmbeddings = null;
        let uploadedFileName = null;
        // é¿å…é‡å¤å£°æ˜ï¼Œè‹¥å·²å­˜åœ¨åˆ™å¤ç”¨
        if (typeof referencedWorkbook === 'undefined') {
            var referencedWorkbook = null;
        }
        let showWorkbookSelection = false;
        let workbookSelectTimeout = null;
        let isTypingWorkbook = false; // æ˜¯å¦æ­£åœ¨è¾“å…¥å·¥ä½œç°¿åç§°
        let inputTimeout = null; // è¾“å…¥å»¶è¿Ÿå®šæ—¶å™¨
        
        // å‘½ä»¤ç›¸å…³å…¨å±€å˜é‡
        let showCommandDropdown = false;
        let commandDropdownTimeout = null;
        let availableCommands = [
            {
                trigger: '/å¼•ç”¨æ–‡ä»¶',
                description: 'å¼•ç”¨å·¥ä½œç°¿ï¼Œå°†å·¥ä½œç°¿ä½œä¸ºé™„ä»¶ä¸Šä¼ åˆ°AIèŠå¤©å¤§æ¨¡å‹',
                action: 'showWorkbookSelection'
            },
            {
                trigger: '/è·å–æ–‡æ¡£å†…å®¹',
                aliases: ['/getdoc'],
                description: 'è·å–å½“å‰WPSæ–‡æ¡£çš„å†…å®¹',
                action: 'getDocumentContent'
            },
            {
                trigger: '/å†™å…¥æ–‡æ¡£',
                description: 'å°†å†…å®¹è¿½åŠ åˆ°å½“å‰æ–‡æ¡£',
                action: 'writeToDocument'
            },
            {
                trigger: '/æ¸…ç©ºæ–‡æ¡£',
                description: 'æ¸…ç©ºå½“å‰æ–‡æ¡£å†…å®¹ï¼ˆè¯·è°¨æ…ä½¿ç”¨ï¼‰',
                action: 'clearDocument'
            },
            {
                trigger: '/help',
                aliases: ['/å¸®åŠ©'],
                description: 'æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯',
                action: 'showHelp'
            },
            {
                trigger: '/models',
                aliases: ['/æ¨¡å‹'],
                description: 'è·å–å¯ç”¨çš„AIæ¨¡å‹åˆ—è¡¨',
                action: 'getModels'
            },
            {
                trigger: '!completion',
                aliases: ['!è¡¥å…¨'],
                description: 'ä½¿ç”¨completions APIè¿›è¡Œæ–‡æœ¬è¡¥å…¨',
                action: 'textCompletion'
            }
        ];
        
        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            const maxHeight = 200; // æœ€å¤§é«˜åº¦
            const newHeight = Math.min(textarea.scrollHeight, maxHeight);
            textarea.style.height = newHeight + 'px';
            
            // å¦‚æœå†…å®¹è¶…è¿‡æœ€å¤§é«˜åº¦ï¼Œæ˜¾ç¤ºæ»šåŠ¨æ¡
            if (textarea.scrollHeight > maxHeight) {
                textarea.style.overflowY = 'auto';
            } else {
                textarea.style.overflowY = 'hidden';
            }
        }

        // åˆ‡æ¢æ ¼å¼åŒ–å·¥å…·æ æ˜¾ç¤º
        function toggleFormatToolbar() {
            const toolbar = document.querySelector('.format-toolbar');
            if (toolbar) {
                toolbar.style.display = toolbar.style.display === 'none' ? 'flex' : 'none';
            }
        }

        // å¯Œæ–‡æœ¬æ ¼å¼åŒ–
        function formatText(command) {
            const textarea = document.getElementById('userInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let formattedText;
            switch (command) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'underline':
                    formattedText = `<u>${selectedText}</u>`;
                    break;
                case 'strike':
                    formattedText = `~~${selectedText}~~`;
                    break;
                case 'code':
                    formattedText = `\`${selectedText}\``;
                    break;
                default:
                    formattedText = selectedText;
            }
            
            // æ›¿æ¢é€‰ä¸­çš„æ–‡æœ¬
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            
            // è®¾ç½®å…‰æ ‡ä½ç½®
            const newCursorPos = start + formattedText.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
            
            // é‡æ–°è°ƒæ•´é«˜åº¦
            autoResizeTextarea(textarea);
        }

        // åˆå§‹åŒ–textareaäº‹ä»¶
        function initializeTextareaEvents() {
            const textarea = document.getElementById('userInput');
            if (textarea) {
                // åˆå§‹åŒ–é«˜åº¦
                autoResizeTextarea(textarea);
                
                // åŒå‡»æ˜¾ç¤º/éšè—æ ¼å¼åŒ–å·¥å…·æ 
                textarea.addEventListener('dblclick', function() {
                    toggleFormatToolbar();
                });
                
                // æ–‡æœ¬å˜åŒ–æ—¶è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
            }
        }

        // å®æ—¶ç›‘æ§ç”¨æˆ·è¾“å…¥æ¡†
        function monitorInput() {
            const userInput = document.getElementById('userInput');
            const currentValue = userInput.value.trim(); // å»é™¤é¦–å°¾ç©ºæ ¼è¿›è¡ŒåŒ¹é…
            
            // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
            autoResizeTextarea(userInput);
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (commandDropdownTimeout) {
                clearTimeout(commandDropdownTimeout);
                commandDropdownTimeout = null;
            }
            
            // ç‰¹æ®Šå¤„ç†ï¼š/å¼•ç”¨æ–‡ä»¶å‘½ä»¤ç›´æ¥è§¦å‘å·¥ä½œç°¿é€‰æ‹©
            // æ— éœ€ä¾èµ–å‘½ä»¤ä¸‹æ‹‰æ¡†çŠ¶æ€ï¼Œç›´æ¥æ£€æŸ¥è¾“å…¥å†…å®¹
            if (currentValue === '/å¼•ç”¨æ–‡ä»¶' && !showWorkbookSelection) {
                if (workbookSelectTimeout) {
                    clearTimeout(workbookSelectTimeout);
                    workbookSelectTimeout = null;
                }
                // å…ˆéšè—å‘½ä»¤ä¸‹æ‹‰æ¡†ï¼Œç„¶åæ˜¾ç¤ºå·¥ä½œç°¿é€‰æ‹©ä¸‹æ‹‰æ¡†
                hideCommandDropdown();
                showWorkbookSelectionDropdown();
                return;
            }
            
            // æ£€æµ‹æ˜¯å¦è¾“å…¥"/"æ¥æ˜¾ç¤ºå‘½ä»¤é€‰æ‹©èœå•
            if (currentValue === '/') {
                // åªæœ‰è¾“å…¥çº¯"/"æ—¶æ‰æ˜¾ç¤ºå‘½ä»¤é€‰æ‹©èœå•
                if (!showCommandDropdown && !showWorkbookSelection) {
                    commandDropdownTimeout = setTimeout(() => {
                        showCommandDropdownMenu();
                    }, 200);
                }
            } else {
                // å…¶ä»–æ‰€æœ‰æƒ…å†µï¼ˆåŒ…æ‹¬"/å…¶ä»–å†…å®¹"ã€""ã€æ­£å¸¸æ–‡æœ¬ç­‰ï¼‰éƒ½éšè—å‘½ä»¤ä¸‹æ‹‰æ¡†
                if (showCommandDropdown) {
                    hideCommandDropdown();
                }
            }
            // æ³¨æ„ï¼šä¸å¤„ç†"/ä»»æ„å†…å®¹"çš„æƒ…å†µï¼Œé¿å…æ„å¤–è§¦å‘
            

        }
        
        // è¿‡æ»¤å¹¶æ˜¾ç¤ºå‘½ä»¤
        function filterAndShowCommands(inputText) {
            const commandDropdown = document.getElementById('commandDropdown');
            const commandOptions = document.getElementById('commandOptions');
            
            if (!commandDropdown || !commandOptions) return;
            
            // æ¸…ç©ºé€‰é¡¹
            commandOptions.innerHTML = '';
            
            // è¿‡æ»¤åŒ¹é…çš„å‘½ä»¤
            const filteredCommands = availableCommands.filter(command => {
                const triggers = [command.trigger, ...(command.aliases || [])];
                return triggers.some(trigger => trigger.startsWith(inputText));
            });
            
            // å¦‚æœæœ‰åŒ¹é…çš„å‘½ä»¤ï¼Œæ˜¾ç¤ºå®ƒä»¬
            if (filteredCommands.length > 0) {
                filteredCommands.forEach(command => {
                    const option = document.createElement('div');
                    option.className = 'command-option';
                    const isMatch = command.trigger.startsWith(inputText);
                    option.innerHTML = `
                        <div style="font-weight: 600; color: ${isMatch ? '#a855f7' : '#e0f2fe'};">
                            ${highlightMatch(command.trigger, inputText)}
                        </div>
                        <div class="command-description">${command.description}</div>
                    `;
                    
                    option.onclick = () => selectCommand(command);
                    commandOptions.appendChild(option);
                });
                
                // æ˜¾ç¤ºä¸‹æ‹‰æ¡†
                commandDropdown.style.display = 'block';
                showCommandDropdown = true;
            } else {
                // å¦‚æœæ²¡æœ‰åŒ¹é…çš„å‘½ä»¤ï¼Œéšè—ä¸‹æ‹‰æ¡†
                hideCommandDropdown();
            }
        }
        
        // é«˜äº®åŒ¹é…çš„éƒ¨åˆ†
        function highlightMatch(text, query) {
            if (!query || query === '/') return text;
            const index = text.toLowerCase().indexOf(query.toLowerCase());
            if (index === -1) return text;
            
            const before = text.substring(0, index);
            const match = text.substring(index, index + query.length);
            const after = text.substring(index + query.length);
            
            return `${before}<span style="color: #06b6d4; font-weight: 700;">${match}</span>${after}`;
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ å’Œembeddingsè°ƒç”¨
        function handleFileUpload(files) {
            if (!files || files.length === 0) return;
            
            const file = files[0];
            uploadedFileName = file.name;
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ æ¶ˆæ¯
            const chatBody = document.getElementById('chatBody');
            const fileNameDisplay = document.createElement('div');
            fileNameDisplay.className = 'message user-message';
            fileNameDisplay.textContent = `å·²ä¸Šä¼ æ–‡ä»¶: ${file.name}`;
            chatBody.appendChild(fileNameDisplay);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // æ˜¾ç¤ºå¤„ç†ä¸­æ¶ˆæ¯
            const processingMessage = document.createElement('div');
            processingMessage.className = 'thinking';
            processingMessage.innerHTML = `
                <div class="thinking-header">
                    <span>æ­£åœ¨å¤„ç†æ–‡ä»¶å¹¶ç”ŸæˆåµŒå…¥å‘é‡...</span>
                </div>
            `;
            chatBody.appendChild(processingMessage);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è¯»å–æ–¹å¼
            if (file.type === 'text/plain' || file.type === 'text/csv') {
                reader.readAsText(file);
            } else {
                // å¯¹äºéæ–‡æœ¬æ–‡ä»¶ï¼Œå…ˆè¯»å–ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œç„¶ååœ¨å‰ç«¯å°è¯•æå–æ–‡æœ¬
                reader.readAsArrayBuffer(file);
            }
            
            reader.onload = function(e) {
                let textContent = '';
                
                if (file.type === 'text/plain' || file.type === 'text/csv') {
                    textContent = e.target.result;
                } else {
                    // å¯¹äºéæ–‡æœ¬æ–‡ä»¶ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„æ–‡æœ¬æå–
                    textContent = `[äºŒè¿›åˆ¶æ–‡ä»¶å†…å®¹ï¼Œæ¥è‡ª${file.name}]`;
                    // å¯ä»¥è€ƒè™‘æ·»åŠ PDF.jsç­‰åº“æ¥å¤„ç†PDFæ–‡ä»¶
                }
                
                // é™åˆ¶æ–‡æœ¬é•¿åº¦ï¼Œé¿å…è¿‡å¤§çš„è¯·æ±‚
                const maxLength = 5000;
                if (textContent.length > maxLength) {
                    textContent = textContent.substring(0, maxLength) + '... [å†…å®¹è¿‡é•¿å·²æˆªæ–­]';
                }
                
                // è°ƒç”¨embeddings API
                generateEmbeddings(textContent, file.name, processingMessage);
            };
            
            reader.onerror = function() {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message ai-message';
                errorMessage.textContent = `æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåæˆ–æ ¼å¼æ˜¯å¦æ”¯æŒã€‚`;
                chatBody.appendChild(errorMessage);
                chatBody.scrollTop = chatBody.scrollHeight;
                chatBody.removeChild(processingMessage);
            };
        }
        
        // ç”ŸæˆåµŒå…¥å‘é‡
        function generateEmbeddings(text, fileName, processingMessage) {
            const chatBody = document.getElementById('chatBody');
            
            try {
                const xhr = new XMLHttpRequest();
                const apiUrl = 'http://192.168.70.26:1234/v1/embeddings';
                
                xhr.open('POST', apiUrl);
                xhr.setRequestHeader('Content-Type', 'application/json');
                // å¦‚æœéœ€è¦APIå¯†é’¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
                // xhr.setRequestHeader('Authorization', 'Bearer YOUR_API_KEY');
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        // ç§»é™¤å¤„ç†ä¸­æ¶ˆæ¯
                        chatBody.removeChild(processingMessage);
                        
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                currentEmbeddings = response;
                                
                                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                                const successMessage = document.createElement('div');
                                successMessage.className = 'message ai-message';
                                successMessage.innerHTML = `
                                    <div><strong>åµŒå…¥å‘é‡ç”ŸæˆæˆåŠŸ</strong></div>
                                    <div>æ–‡ä»¶å: ${fileName}</div>
                                    <div>å‘é‡ç»´åº¦: ${response.data[0].embedding.length}</div>
                                    <div>æ¨¡å‹: ${response.model}</div>
                                    <div style="margin-top: 8px; font-size: 12px; opacity: 0.7;">
                                        æ‚¨ç°åœ¨å¯ä»¥åŸºäºæ­¤æ–‡ä»¶è¿›è¡Œé—®ç­”
                                    </div>
                                `;
                                chatBody.appendChild(successMessage);
                            } catch (parseError) {
                                showErrorMessage('è§£æå“åº”å¤±è´¥: ' + parseError.message);
                            }
                        } else {
                            showErrorMessage(`APIè¯·æ±‚å¤±è´¥ (${xhr.status}): ${xhr.statusText}`);
                        }
                        
                        chatBody.scrollTop = chatBody.scrollHeight;
                    }
                };
                
                // å‡†å¤‡è¯·æ±‚ä½“
                const requestBody = JSON.stringify({
                    model: 'text-embedding-ada-002', // ä½¿ç”¨é€‚åˆembeddingsçš„æ¨¡å‹
                    input: text
                });
                
                xhr.send(requestBody);
            } catch (error) {
                chatBody.removeChild(processingMessage);
                showErrorMessage('ç”ŸæˆåµŒå…¥å‘é‡æ—¶å‡ºé”™: ' + error.message);
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showErrorMessage(message) {
            const chatBody = document.getElementById('chatBody');
            const errorMessage = document.createElement('div');
            errorMessage.className = 'message ai-message';
            errorMessage.textContent = message;
            chatBody.appendChild(errorMessage);
        }
        
        // æ˜¾ç¤ºå‘½ä»¤é€‰æ‹©ä¸‹æ‹‰æ¡†
        function showCommandDropdownMenu() {
            const commandDropdown = document.getElementById('commandDropdown');
            const commandOptions = document.getElementById('commandOptions');
            
            if (!commandDropdown || !commandOptions) return;
            
            // æ¸…ç©ºé€‰é¡¹
            commandOptions.innerHTML = '';
            
            // ç”Ÿæˆå‘½ä»¤é€‰é¡¹
            availableCommands.forEach(command => {
                const option = document.createElement('div');
                option.className = 'command-option';
                option.innerHTML = `
                    <div style="font-weight: 600; color: #a855f7;">${command.trigger}</div>
                    <div class="command-description">${command.description}</div>
                `;
                
                option.onclick = () => selectCommand(command);
                commandOptions.appendChild(option);
            });
            
            // æ˜¾ç¤ºä¸‹æ‹‰æ¡†
            commandDropdown.style.display = 'block';
            showCommandDropdown = true;
            
            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­äº‹ä»¶
            setTimeout(() => {
                document.addEventListener('click', hideCommandDropdownOnClickOutside);
            }, 100);
        }
        
        // éšè—å‘½ä»¤é€‰æ‹©ä¸‹æ‹‰æ¡†
        function hideCommandDropdown() {
            const commandDropdown = document.getElementById('commandDropdown');
            if (commandDropdown) {
                commandDropdown.style.display = 'none';
            }
            showCommandDropdown = false;
            
            // ç§»é™¤ç‚¹å‡»å¤–éƒ¨å…³é—­äº‹ä»¶
            document.removeEventListener('click', hideCommandDropdownOnClickOutside);
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­å‘½ä»¤ä¸‹æ‹‰æ¡†
        function hideCommandDropdownOnClickOutside(event) {
            const commandDropdown = document.getElementById('commandDropdown');
            const userInput = document.getElementById('userInput');
            
            if (commandDropdown && !commandDropdown.contains(event.target) && 
                event.target !== userInput && !userInput.contains(event.target)) {
                hideCommandDropdown();
            }
        }
        
        // é€‰æ‹©å‘½ä»¤
        function selectCommand(command) {
            const userInput = document.getElementById('userInput');
            
            // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„å®šæ—¶å™¨
            if (commandDropdownTimeout) {
                clearTimeout(commandDropdownTimeout);
                commandDropdownTimeout = null;
            }
            if (workbookSelectTimeout) {
                clearTimeout(workbookSelectTimeout);
                workbookSelectTimeout = null;
            }
            
            // éšè—ä¸‹æ‹‰æ¡†ï¼ˆé¦–å…ˆéšè—ï¼Œé¿å…monitorInputå¹²æ‰°ï¼‰
            hideCommandDropdown();
            
            // æ‰§è¡Œç›¸åº”çš„æ“ä½œ
            executeCommandAction(command);
            
            // å»¶è¿Ÿæ›´æ–°è¾“å…¥æ¡†ï¼Œè®©executeCommandActionå…ˆæ‰§è¡Œ
            setTimeout(() => {
                userInput.value = command.trigger + ' ';
                userInput.focus();
            }, 50);
        }
        
        // æ‰§è¡Œå‘½ä»¤åŠ¨ä½œ
        function executeCommandAction(command) {
            switch(command.action) {
                case 'showWorkbookSelection':
                    // æ¸…é™¤ä»»ä½•ç°æœ‰çš„å®šæ—¶å™¨å’Œä¸‹æ‹‰æ¡†çŠ¶æ€
                    if (commandDropdownTimeout) {
                        clearTimeout(commandDropdownTimeout);
                        commandDropdownTimeout = null;
                    }
                    if (workbookSelectTimeout) {
                        clearTimeout(workbookSelectTimeout);
                        workbookSelectTimeout = null;
                    }
                    hideCommandDropdown();
                    // ç«‹å³æ‰§è¡Œå·¥ä½œç°¿é€‰æ‹©
                    showWorkbookSelectionDropdown();
                    break;
                case 'showHelp':
                    sendMessage(); // å¸®åŠ©ä¿¡æ¯ç”±sendMessageå¤„ç†
                    break;
                case 'getModels':
                    sendMessage(); // æ¨¡å‹åˆ—è¡¨ç”±sendMessageå¤„ç†
                    break;
                case 'textCompletion':
                    // èšç„¦åˆ°è¾“å…¥æ¡†ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥æç¤º
                    const userInput = document.getElementById('userInput');
                    setTimeout(() => userInput.focus(), 100);
                    break;
                case 'getDocumentContent':
                case 'writeToDocument':
                case 'clearDocument':
                    // è¿™äº›å‘½ä»¤éœ€è¦åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å†…å®¹ï¼Œæš‚ä¸è‡ªåŠ¨æ‰§è¡Œ
                    break;
            }
        }
        
        // WPS API å…¨å±€å˜é‡
        // æ³¨æ„ï¼šwpså˜é‡ç”±wpsLoad.jsè‡ªåŠ¨åˆ›å»ºï¼Œä¸è¦åœ¨è¿™é‡Œé‡å¤å£°æ˜
        let isWpsLoaded = false;
        let wpsStatus = {
            connected: false,
            documentType: null,
            lastChecked: null,
            currentDocumentName: null,
            connectionTime: null
        };
        
        // æ›´æ–°WPSçŠ¶æ€ï¼ˆä¿æŒæ ¸å¿ƒåŠŸèƒ½ä½†ä¸æ›´æ–°UIï¼‰
        function updateWpsStatus(connected, info, documentType = null, documentName = null) {
            // ç¡®ä¿documentTypeæ ‡å‡†åŒ–
            if (documentType) {
                switch (documentType.toLowerCase()) {
                    case 'spreadsheet':
                    case 'excel':
                    case 'xls':
                    case 'xlsx':
                        documentType = 'Excelè¡¨æ ¼';
                        break;
                    case 'presentation':
                    case 'powerpoint':
                    case 'ppt':
                    case 'pptx':
                        documentType = 'æ¼”ç¤ºæ–‡ç¨¿';
                        break;
                    case 'document':
                    case 'word':
                    case 'doc':
                    case 'docx':
                        documentType = 'Wordæ–‡æ¡£';
                        break;
                }
            }
            
            // åªæ›´æ–°çŠ¶æ€å˜é‡ï¼Œä¸æ›´æ–°UI
            if (connected) {
                if (documentName) {
                    wpsStatus.currentDocumentName = documentName;
                }
                
                // è®°å½•é¦–æ¬¡è¿æ¥æ—¶é—´
                if (!wpsStatus.connectionTime) {
                    wpsStatus.connectionTime = new Date();
                }
            } else {
                // æ–­å¼€è¿æ¥æ—¶é‡ç½®çŠ¶æ€
                wpsStatus.currentDocumentName = null;
                wpsStatus.connectionTime = null;
                window.Application = null;
            }
            
            wpsStatus.connected = connected;
            wpsStatus.documentType = documentType;
            wpsStatus.lastChecked = new Date();
            
            // åªåœ¨æ§åˆ¶å°è®°å½•ï¼Œä¸æ˜¾ç¤ºåœ¨UIä¸Š
            // WPSè¿æ¥çŠ¶æ€æ—¥å¿—å·²ç®€åŒ– 
            //     `WPSçŠ¶æ€: å·²è¿æ¥ ${documentName ? `åˆ° ${documentName}` : ''} ${documentType ? `(${documentType})` : ''}` : 
            //     `WPSçŠ¶æ€: ${info}`);
        }
        
        // åˆ‡æ¢å¸®åŠ©è¯´æ˜æ˜¾ç¤º/éšè—
        function toggleHelp() {
            const helpSection = document.getElementById('helpSection');
            if (helpSection) {
                helpSection.classList.toggle('show');
            }
        }
        
        // ç§»é™¤é‡å¤çš„é¡µé¢åŠ è½½äº‹ä»¶ç›‘å¬å™¨
        
        // åˆå§‹åŒ–WPS API - æ­¤é¡¹ç›®ä¸ºWPS JSAé¡¹ç›®ï¼Œç›´æ¥åœ¨WPSè¡¨æ ¼ç¯å¢ƒä¸‹è¿è¡Œ
        function initializeWpsAPI() {
            // é‡ç½®çŠ¶æ€
            window.Application = null;
            isWpsLoaded = false;
            
            // ç›´æ¥å°è¯•åŠ è½½WPS APIï¼Œæ— éœ€ç¯å¢ƒæ£€æŸ¥
            // WPS APIåˆå§‹åŒ–æ—¥å¿—å·²ç®€åŒ–
            loadWpsAPIWithRetry();
        }
        
        // ä½¿ç”¨å®˜æ–¹æ¨èçš„wpsLoadæ–¹æ³•åŠ è½½WPS APIï¼ˆé™é»˜è¿è¡Œï¼‰
        function loadWpsAPIWithRetry() {
            try {
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºä¸ºè¿æ¥ä¸­
                updateWpsStatus(false, 'æ­£åœ¨è¿æ¥WPS...', null);
                
                // åªä½¿ç”¨å®˜æ–¹æ¨èçš„wpsLoad()æ–¹æ³•
                if (window.wpsLoad && typeof window.wpsLoad === 'function') {
                    // wpsLoadæ–¹æ³•åŠ è½½æ—¥å¿—å·²ç®€åŒ–
                    
                    // wpsLoadè¿”å›Promise - ä¸¥æ ¼ä½¿ç”¨window.wpsLoadä»¥ç¡®ä¿æ­£ç¡®å¼•ç”¨
                    window.wpsLoad().then(function(wpsObj) {
                        if (wpsObj && typeof wpsObj === 'object') {
                            // æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨Applicationä½œä¸ºæ ¹å¯¹è±¡
                            window.Application = wpsObj.Application || wpsObj;
                            isWpsLoaded = true;
                            // WPS APIåŠ è½½æˆåŠŸæ—¥å¿—å·²ç®€åŒ–
                            // WPSç¯å¢ƒè¿æ¥æ—¥å¿—å·²ç®€åŒ–
                            
                            // ç«‹å³å°è¯•è·å–å·¥ä½œç°¿ä¿¡æ¯éªŒè¯è¿æ¥
                            verifyWpsConnection();
                        } else {
                            // WPS APIåŠ è½½å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…å·²ç®€åŒ–
                            updateWpsStatus(false, 'WPSå®¢æˆ·ç«¯è¿æ¥å¤±è´¥');
                        }
                    }).catch(function(error) {
                        // WPS APIåŠ è½½å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…å·²ç®€åŒ–
                        updateWpsStatus(false, 'WPSå®¢æˆ·ç«¯è¿æ¥å¤±è´¥');
                    });
                } else {
                    // wpsLoadæœªå®šä¹‰ï¼Œé”™è¯¯è¯¦æƒ…å·²ç®€åŒ–
                    updateWpsStatus(false, 'wpsLoadæœªå®šä¹‰');
                }
            } catch (e) {
                // WPS APIåŠ è½½é”™è¯¯ï¼Œé”™è¯¯è¯¦æƒ…å·²ç®€åŒ–
                updateWpsStatus(false, `è¿æ¥å¤±è´¥: ${e.message}`);
            }
        }
        
        // å®šæœŸæ£€æŸ¥WPSè¿æ¥çŠ¶æ€ï¼ˆåå°é™é»˜è¿è¡Œï¼‰
        function startWpsStatusCheck() {
            setInterval(() => {
                if (isWpsLoaded && window.Application) {
                    try {
                        // å®šæœŸåˆ·æ–°WPSå·¥ä½œç°¿ä¿¡æ¯æ—¥å¿—å·²ç®€åŒ–
                        // ä½¿ç”¨verifyWpsConnectionéªŒè¯è¿æ¥å¹¶åˆ·æ–°å·¥ä½œç°¿ä¿¡æ¯
                        const isConnected = verifyWpsConnection();
                        
                        if (!isConnected) {
                            // è¿æ¥éªŒè¯å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–
                            throw new Error('å·¥ä½œç°¿ä¿¡æ¯åˆ·æ–°å¤±è´¥');
                        }
                        
                    } catch (e) {
                        // WPSè¿æ¥é‡è¯•å·²ç®€åŒ–
                        isWpsLoaded = false;
                        window.Application = null;
                        // ä¸æ˜¾ç¤ºUIæ¶ˆæ¯ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
                        updateWpsStatus(false, 'è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡æ–°è¿æ¥...');
                        setTimeout(initializeWpsAPI, 1000);
                    }
                }
            }, 10000); // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡å·¥ä½œç°¿ä¿¡æ¯
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            initializeWpsAPI();
            // ä¿æŒçŠ¶æ€æ£€æŸ¥ä½†ä¸æ›´æ–°UI
            startWpsStatusCheck();
        });
        
        // éªŒè¯WPSè¿æ¥å¹¶è·å–å·¥ä½œç°¿ä¿¡æ¯ - ä¸¥æ ¼æŒ‰ç…§WPSå®˜æ–¹JSAè§„èŒƒå®ç°
        function verifyWpsConnection() {
            // é¦–å…ˆç¡®ä¿Applicationå¯¹è±¡å·²åˆå§‹åŒ–
            if (!window.Application || typeof window.Application !== 'object') {
                updateWpsStatus(false, 'Applicationå¯¹è±¡æœªåˆå§‹åŒ–');
                return false;
            }
            
            try {
                // WPSè¿æ¥éªŒè¯æ—¥å¿—å·²ç®€åŒ–
                
                // æ ¹æ®WPSå®˜æ–¹JSAè§„èŒƒï¼Œåº”ä½¿ç”¨Applicationä½œä¸ºæ ¹å¯¹è±¡ï¼Œä¸”æŒ‰ç…§åº”ç”¨ç±»å‹åˆ†åˆ«è·å–æ´»åŠ¨æ–‡æ¡£
                let activeDocument = null;
                
                // é¦–å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºExcelåº”ç”¨ - ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒ
                if (typeof window.Application.Workbooks !== 'undefined') {
                    // Excelåº”ç”¨ç¯å¢ƒæ£€æµ‹æ—¥å¿—å·²ç®€åŒ–
                    try {
                        // ä½¿ç”¨Workbooksé›†åˆæ¥åˆ¤æ–­å¹¶è·å–æ´»åŠ¨å·¥ä½œç°¿
                        if (window.Application.Workbooks.Count > 0 && window.Application.ActiveWorkbook) {
                            activeDocument = window.Application.ActiveWorkbook;
                            // Excelæ´»åŠ¨å·¥ä½œç°¿è·å–æˆåŠŸæ—¥å¿—å·²ç®€åŒ–
                        }
                    } catch (wbError) {
                        // Excelå·¥ä½œç°¿è·å–é”™è¯¯å·²ç®€åŒ–
                    }
                } 
                // å¯¹äºWord/PowerPointæ–‡æ¡£
                else if (typeof window.Application.Documents !== 'undefined' || 
                         typeof window.Application.Presentations !== 'undefined') {
                    // Wordæˆ–PowerPointåº”ç”¨ç¯å¢ƒæ£€æµ‹æ—¥å¿—å·²ç®€åŒ–
                    try {
                        if (window.Application.ActiveDocument) {
                            activeDocument = window.Application.ActiveDocument;
                            // Word/PowerPointæ´»åŠ¨æ–‡æ¡£è·å–æˆåŠŸæ—¥å¿—å·²ç®€åŒ–
                        }
                    } catch (docError) {
                        // æ–‡æ¡£è·å–é”™è¯¯å·²ç®€åŒ–
                    }
                }
                
                if (activeDocument) {
                    try {
                        // WPSå®˜æ–¹JSAè§„èŒƒå¤„ç†æ–‡æ¡£å¯¹è±¡æ—¥å¿—å·²ç®€åŒ–
                        
                        // ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒç¡®å®šæ–‡æ¡£ç±»å‹å’Œåç§°
                        let documentType = null;
                        let docName = '';
                        
                        // é¦–å…ˆåˆ¤æ–­åº”ç”¨ç±»å‹ - è¿™æ˜¯JSAè§„èŒƒæ¨èçš„æ–¹å¼
                        // ä½¿ç”¨Applicationå¯¹è±¡çš„é›†åˆå±æ€§æ¥åˆ¤æ–­åº”ç”¨ç±»å‹
                        if (typeof window.Application.Workbooks !== 'undefined') {
                            // Excelåº”ç”¨
                            documentType = 'Excel';
                            try {
                                // ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒï¼Œä½¿ç”¨window.Application.ActiveWorkbook
                                docName = String(window.Application.ActiveWorkbook.Name || 'æœªçŸ¥Excelå·¥ä½œç°¿');
                                // Excelå·¥ä½œç°¿è¯†åˆ«æ—¥å¿—å·²ç®€åŒ–
                            } catch (wbNameError) {
                                // è·å–å·¥ä½œç°¿åç§°é”™è¯¯å·²ç®€åŒ–
                                docName = 'æœªçŸ¥Excelå·¥ä½œç°¿';
                            }
                        }
                        else if (typeof window.Application.Documents !== 'undefined') {
                            // Wordåº”ç”¨
                            documentType = 'Word';
                            docName = String(activeDocument.Name || 'æœªçŸ¥Wordæ–‡æ¡£');
                            // Wordæ–‡æ¡£è¯†åˆ«æ—¥å¿—å·²ç®€åŒ–
                        }
                        else if (typeof window.Application.Presentations !== 'undefined') {
                            // PowerPointåº”ç”¨
                            documentType = 'PowerPoint';
                            docName = String(activeDocument.Name || 'æœªçŸ¥PowerPointæ–‡æ¡£');
                            // PowerPointæ–‡æ¡£è¯†åˆ«æ—¥å¿—å·²ç®€åŒ–
                        }
                        else {
                            // é€šç”¨æ–‡æ¡£å¤„ç† - ä½¿ç”¨æ–‡ä»¶æ‰©å±•åè¾…åŠ©åˆ¤æ–­
                            docName = String(activeDocument.Name || 'æœªçŸ¥æ–‡æ¡£');
                            const normalizedName = docName.toLowerCase();
                            if (normalizedName.endsWith('.docx') || normalizedName.endsWith('.doc')) {
                                documentType = 'Word';
                                // Wordæ–‡æ¡£æ‰©å±•åè¯†åˆ«æ—¥å¿—å·²ç®€åŒ–
                            } else if (normalizedName.endsWith('.pptx') || normalizedName.endsWith('.ppt')) {
                                  documentType = 'PowerPoint';
                                  // PowerPointæ–‡æ¡£æ‰©å±•åè¯†åˆ«æ—¥å¿—å·²ç®€åŒ–
                            } else if (normalizedName.endsWith('.xlsx') || normalizedName.endsWith('.xls') || normalizedName.endsWith('.et')) {
                                documentType = 'Excel';
                                // console.log('å·²è¯†åˆ«ä¸ºExcelå·¥ä½œç°¿ (åŸºäºæ‰©å±•å)');
                            } else {
                                documentType = 'WPS';
                                // console.log('å·²è¯†åˆ«ä¸ºé€šç”¨WPSæ–‡æ¡£ (åŸºäºæ‰©å±•å)');
                            }
                        }
                        
                        // æ£€æŸ¥å·¥ä½œç°¿åç§°æ˜¯å¦å˜åŒ–
                        const hasDocumentChanged = wpsStatus.currentDocumentName !== docName;
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ŒåŒ…å«å·¥ä½œç°¿åç§°
                        updateWpsStatus(true, `å·²è¿æ¥: ${docName}`, documentType, docName);
                        
                        // å¦‚æœå·¥ä½œç°¿å˜åŒ–ï¼Œè®°å½•æ—¥å¿—
                        if (hasDocumentChanged) {
                            // WPSæ–‡æ¡£åˆ‡æ¢æ—¥å¿—å·²ç®€åŒ–
                        } else {
                            // WPSè¿æ¥éªŒè¯æˆåŠŸæ—¥å¿—å·²ç®€åŒ–
                        }
                        
                        return true;
                    } catch (nameError) {
                        // æ— æ³•è·å–æ–‡æ¡£åç§°æ—¶é”™è¯¯å·²ç®€åŒ–
                        updateWpsStatus(true, 'WPSå·²è¿æ¥ï¼Œæ–‡æ¡£å¯¹è±¡æœ‰æ•ˆä½†æ— æ³•è·å–åç§°', null);
                        return true;
                    }
                } else {
                    // WPSå·²åŠ è½½ä½†æ— æ´»åŠ¨æ–‡æ¡£æˆ–å·¥ä½œç°¿
                    // æ£€æŸ¥æ˜¯Excelåº”ç”¨ä½†æ²¡æœ‰æ‰“å¼€å·¥ä½œç°¿ï¼Œè¿˜æ˜¯å…¶ä»–æƒ…å†µ
                    let statusMessage = 'WPSå®¢æˆ·ç«¯å·²è¿æ¥ï¼Œæ— æ´»åŠ¨æ–‡æ¡£';
                    try {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯Excelåº”ç”¨ç¨‹åº - ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒä½¿ç”¨window.Application
                        if (typeof window.Application.Workbooks !== 'undefined') {
                            // Excelåº”ç”¨æ£€æµ‹æ—¥å¿—å·²ç®€åŒ–
                            statusMessage = 'WPSå·²è¿æ¥ï¼Œç­‰å¾…æ‰“å¼€å·¥ä½œç°¿';
                            // WPSè¿æ¥çŠ¶æ€æ—¥å¿—å·²ç®€åŒ–
                        } else {
                            // WPSè¿æ¥çŠ¶æ€æ—¥å¿—å·²ç®€åŒ–
                            // å°è¯•è·å–åº”ç”¨ç¨‹åºä¿¡æ¯
                            try {
                                if (window.Application.Version) {
                                    // WPSç‰ˆæœ¬ä¿¡æ¯æ—¥å¿—å·²ç®€åŒ–
                                }
                            } catch (versionError) {
                                // è·å–ç‰ˆæœ¬ä¿¡æ¯é”™è¯¯å·²ç®€åŒ–
                            }
                        }
                    } catch (e) {
                        // åº”ç”¨ç±»å‹æ£€æŸ¥é”™è¯¯å·²ç®€åŒ–
                    }
                    updateWpsStatus(true, statusMessage, null);
                    return true;
                }
                
            } catch (e) {
                // è¯¦ç»†çš„é”™è¯¯ç±»å‹åŒºåˆ†å’Œå¤„ç†
                let errorMsg = '';
                const timestamp = new Date().toLocaleTimeString();
                
                if (e instanceof TypeError) {
                    errorMsg = 'ç±»å‹é”™è¯¯ï¼šWPSå¯¹è±¡æ–¹æ³•æˆ–å±æ€§ä¸å­˜åœ¨';
                    // WPSè¿æ¥ç±»å‹é”™è¯¯æ—¥å¿—å·²ç®€åŒ–
                } else if (e instanceof ReferenceError) {
                    errorMsg = 'å¼•ç”¨é”™è¯¯ï¼šWPSæ–¹æ³•å¼•ç”¨é”™è¯¯';
                    // WPSè¿æ¥å¼•ç”¨é”™è¯¯æ—¥å¿—å·²ç®€åŒ–
                } else {
                    errorMsg = `è¿æ¥éªŒè¯å¤±è´¥: ${e.message || 'æœªçŸ¥é”™è¯¯'}`;
                    // WPSè¿æ¥æœªåˆ†ç±»é”™è¯¯æ—¥å¿—å·²ç®€åŒ–
                }
                
                updateWpsStatus(false, errorMsg);
                return false;
            }
        }
        
        // æ£€æŸ¥WPSæ˜¯å¦å¯ç”¨ï¼Œå¹¶æä¾›è¯¦ç»†çŠ¶æ€ä¿¡æ¯ - ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒ
        function checkWpsAvailability() {
            // WPSå¯ç”¨æ€§æ£€æŸ¥æ—¥å¿—å·²ç®€åŒ–
            // é¦–å…ˆæ£€æŸ¥åŸºæœ¬çŠ¶æ€
            if (!isWpsLoaded || !window.Application) {
                // WPS APIçŠ¶æ€æ£€æŸ¥å·²ç®€åŒ–
                updateWpsStatus(false, 'WPS APIæœªåŠ è½½ï¼Œè¯·ç¡®ä¿åœ¨WPSç¯å¢ƒä¸­è¿è¡Œ');
                return false;
            }
            
            // ä½¿ç”¨verifyWpsConnectionè¿›è¡Œå®Œæ•´éªŒè¯ï¼Œä»¥è¯»å–å·¥ä½œç°¿ä¿¡æ¯ä¸ºæˆåŠŸæ¡ä»¶
            return verifyWpsConnection();
        }
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showWpsErrorMessage(message, error = null) {
            const errorMsg = error ? `${message}: ${error.message}` : message;
            // WPSæ“ä½œé”™è¯¯æ—¥å¿—å·²ç®€åŒ–
            addMessage('ai', errorMsg);
            return errorMsg;
        }
        
        // æµ‹è¯•WPS Excelå·¥ä½œç°¿è¿æ¥å’ŒåŸºæœ¬æ“ä½œ - ä¸¥æ ¼éµå¾ªWPSå®˜æ–¹JSAè§„èŒƒ
        function testExcelConnection() {
            // WPS Excelè¿æ¥æµ‹è¯•æ—¥å¿—å·²ç®€åŒ–
            
            try {
                // é¦–å…ˆéªŒè¯Applicationå¯¹è±¡æ˜¯å¦å­˜åœ¨
                if (!window.Application || typeof window.Application !== 'object') {
                    // Applicationå¯¹è±¡æœªåˆå§‹åŒ–é”™è¯¯å·²ç®€åŒ–
                    updateWpsStatus(false, 'Applicationå¯¹è±¡æœªåˆå§‹åŒ–');
                    return false;
                }
                
                // ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒï¼Œå…ˆéªŒè¯æ˜¯å¦ä¸ºExcelåº”ç”¨
                if (typeof window.Application.Workbooks === 'undefined') {
                    // Excelç¯å¢ƒæ£€æµ‹æ—¥å¿—å·²ç®€åŒ–
                    return true;
                }
                
                // Excelåº”ç”¨ç¯å¢ƒç¡®è®¤æ—¥å¿—å·²ç®€åŒ–
                
                // ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒæ£€æŸ¥å·¥ä½œç°¿çŠ¶æ€
                try {
                    // é¦–å…ˆæ£€æŸ¥Workbooksé›†åˆçš„æ•°é‡
                    const workbookCount = window.Application.Workbooks.Count;
                    // å·¥ä½œç°¿æ•°é‡æ£€æŸ¥æ—¥å¿—å·²ç®€åŒ–
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨å·¥ä½œç°¿
                    if (window.Application.ActiveWorkbook) {
                        // ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒï¼Œä½¿ç”¨window.Application.ActiveWorkbook
                        const activeWorkbook = window.Application.ActiveWorkbook;
                        
                        // è·å–å·¥ä½œç°¿åç§° - ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒå¤„ç†
                        let workbookName = 'æœªçŸ¥å·¥ä½œç°¿';
                        try {
                            workbookName = String(activeWorkbook.Name);
                            // æ´»åŠ¨å·¥ä½œç°¿åç§°è·å–æ—¥å¿—å·²ç®€åŒ–
                        } catch (nameError) {
                            // è·å–å·¥ä½œç°¿åç§°é”™è¯¯å·²ç®€åŒ–
                        }
                        
                        // å°è¯•è·å–å·¥ä½œè¡¨ä¿¡æ¯ - ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒ
                        try {
                            // åœ¨WPS JSAä¸­ï¼Œå·¥ä½œè¡¨é›†åˆæ˜¯Worksheets
                            const worksheetCount = activeWorkbook.Worksheets.Count;
                            // å·¥ä½œè¡¨æ•°é‡æ£€æŸ¥æ—¥å¿—å·²ç®€åŒ–
                        } catch (sheetsError) {
                            // è·å–å·¥ä½œè¡¨ä¿¡æ¯é”™è¯¯å·²ç®€åŒ–
                        }
                        
                        // å°è¯•è·å–æ´»åŠ¨å·¥ä½œè¡¨ - ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒ
                        try {
                            if (window.Application.ActiveSheet) {
                                const activeSheet = window.Application.ActiveSheet;
                                const sheetName = activeSheet.Name || 'æœªå‘½åå·¥ä½œè¡¨';
                                // æ´»åŠ¨å·¥ä½œè¡¨åç§°æ—¥å¿—å·²ç®€åŒ–
                                
                                // å°è¯•è¯»å–ä¸€ä¸ªå•å…ƒæ ¼å†…å®¹ä½œä¸ºåŸºæœ¬åŠŸèƒ½æµ‹è¯•
                                try {
                                    // ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒè®¿é—®å•å…ƒæ ¼
                                    const cellValue = activeSheet.Range('A1').Value || 'ç©º';
                                    // A1å•å…ƒæ ¼å†…å®¹æ£€æŸ¥æ—¥å¿—å·²ç®€åŒ–
                                } catch (cellError) {
                                    // è¯»å–å•å…ƒæ ¼å†…å®¹é”™è¯¯å·²ç®€åŒ–
                                }
                            }
                        } catch (sheetError) {
                            // è·å–æ´»åŠ¨å·¥ä½œè¡¨é”™è¯¯å·²ç®€åŒ–
                        }
                        
                        // è®°å½•Excelåº”ç”¨ç‰ˆæœ¬ä¿¡æ¯ - ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒ
                        try {
                            if (window.Application.Version) {
                                // WPSç‰ˆæœ¬ä¿¡æ¯è®°å½•æ—¥å¿—å·²ç®€åŒ–
                            }
                        } catch (versionError) {
                            // è·å–ç‰ˆæœ¬ä¿¡æ¯é”™è¯¯å·²ç®€åŒ–
                        }
                        
                        updateWpsStatus(true, `å·²æˆåŠŸè¿æ¥åˆ°Excelå·¥ä½œç°¿: ${workbookName}`, 'Excel');
                        return true;
                    } else {
                        // æ²¡æœ‰æ´»åŠ¨å·¥ä½œç°¿ï¼Œä½†WPSå·²è¿æ¥
                        // WPSè¿æ¥æ— å·¥ä½œç°¿çŠ¶æ€æ—¥å¿—å·²ç®€åŒ–
                        updateWpsStatus(true, 'WPSå·²è¿æ¥ï¼Œç­‰å¾…æ‰“å¼€å·¥ä½œç°¿', 'Excel');
                        
                        // æµ‹è¯•åŸºæœ¬çš„Excelåº”ç”¨åŠŸèƒ½ - ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒ
                        try {
                            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è®¿é—®Workbooksé›†åˆ
                            if (typeof window.Application.Workbooks === 'object') {
                                // Workbooksé›†åˆè®¿é—®æ£€æŸ¥æ—¥å¿—å·²ç®€åŒ–
                                // å¯ä»¥å°è¯•åˆ›å»ºä¸€ä¸ªæ–°å·¥ä½œç°¿çš„é€»è¾‘ï¼ˆè¿™é‡Œä»…æ£€æŸ¥è®¿é—®æƒé™ï¼‰
                                // const newWorkbook = window.Application.Workbooks.Add();
                                // åˆ›å»ºæ–°å·¥ä½œç°¿æ—¥å¿—å·²ç®€åŒ–
                            }
                        } catch (excelError) {
                            // æµ‹è¯•ExcelåŠŸèƒ½é”™è¯¯å·²ç®€åŒ–
                        }
                        
                        return true;
                    }
                } catch (wbAccessError) {
                    // è®¿é—®Workbooksé›†åˆé”™è¯¯å·²ç®€åŒ–
                    updateWpsStatus(false, `æ— æ³•è®¿é—®Excelå·¥ä½œç°¿: ${wbAccessError.message}`);
                    return false;
                }
            } catch (e) {
                // Excelè¿æ¥æµ‹è¯•å¤±è´¥é”™è¯¯å·²ç®€åŒ–
                updateWpsStatus(false, `Excelè¿æ¥æµ‹è¯•å¤±è´¥: ${e.message}`);
                return false;
            }
        }
        
        // å°è¯•æ“ä½œWPSæ–‡æ¡£ï¼Œå¸¦é‡è¯•é€»è¾‘
        function tryWpsOperation(operation, maxRetries = 2) {
            let retries = 0;
            
            function attempt() {
                try {
                    return operation();
                } catch (error) {
                    retries++;
                    // WPSæ“ä½œé‡è¯•å¤±è´¥å·²ç®€åŒ–
                    
                    if (retries <= maxRetries) {
                        // çŸ­æš‚å»¶è¿Ÿåé‡è¯•
                        return new Promise(resolve => {
                            setTimeout(() => {
                                resolve(attempt());
                            }, 300 * retries);
                        });
                    }
                    
                    throw error;
                }
            }
            
            return attempt();
        }
        
        // ä»WPSæ–‡æ¡£è·å–å†…å®¹
        function getWpsDocumentContent() {
            if (!checkWpsAvailability()) {
                return showWpsErrorMessage('WPSç¯å¢ƒæœªè¿æ¥æˆ–æ— æ•ˆï¼Œæ— æ³•è·å–æ–‡æ¡£å†…å®¹');
            }
            
            try {
                // ä½¿ç”¨tryWpsOperationå‡½æ•°è¿›è¡Œå¸¦é‡è¯•çš„æ“ä½œ
                const content = tryWpsOperation(() => {
                    // è·å–å½“å‰æ´»åŠ¨æ–‡æ¡£
                    // ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒï¼Œä½¿ç”¨window.Application
const activeDocument = window.Application.ActiveDocument;
                    if (!activeDocument) {
                        throw new Error('æœªæ‰¾åˆ°æ´»åŠ¨æ–‡æ¡£ï¼Œè¯·å…ˆæ‰“å¼€ä¸€ä¸ªWPSæ–‡æ¡£');
                    }
                    
                    // éªŒè¯æ–‡æ¡£å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
                    if (!activeDocument.Name) {
                        throw new Error('æ–‡æ¡£å¯¹è±¡æ— æ•ˆï¼Œæ— æ³•è·å–æ–‡æ¡£ä¿¡æ¯');
                    }
                    
                    // æ­£åœ¨å¤„ç†æ–‡æ¡£æ—¥å¿—å·²ç®€åŒ–
                    
                    // è·å–æ–‡æ¡£ç±»å‹
                    let documentType = null;
                    if (activeDocument.Name.endsWith('.docx')) {
                        documentType = 'Word';
                    } 
                    else if (activeDocument.Name.endsWith('.pptx')) {
                        documentType = 'PowerPoint';
                    }
                    else if (activeDocument.Name.endsWith('.xlsx')) {
                        documentType = 'Excel';
                    }
                    else {
                        documentType = 'WPS';
                    }
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ŒåŒ…å«æ–‡æ¡£ç±»å‹
                    updateWpsStatus(true, 'WPSå®¢æˆ·ç«¯å·²è¿æ¥', documentType);
                    
                    // æ ¹æ®æ–‡æ¡£ç±»å‹è·å–å†…å®¹
                    if (activeDocument.Name.endsWith('.docx')) {
                        return extractWordContent(activeDocument);
                    } 
                    else if (activeDocument.Name.endsWith('.pptx')) {
                        return extractPowerPointContent(activeDocument);
                    }
                    else if (activeDocument.Name.endsWith('.xlsx')) {
                        return extractExcelContent(activeDocument);
                    }
                    else {
                        // å°è¯•è·å–é€šç”¨å†…å®¹
                        try {
                            return 'ä¸æ”¯æŒçš„æ–‡æ¡£ç±»å‹ï¼š' + activeDocument.Name + '\n' +
                                   'å°è¯•è·å–é€šç”¨å†…å®¹ï¼š\n' + activeDocument.Content.Text;
                        } catch (e) {
                            throw new Error('ä¸æ”¯æŒçš„æ–‡æ¡£ç±»å‹æˆ–æ— æ³•è·å–å†…å®¹ï¼š' + activeDocument.Name);
                        }
                    }
                });
                
                // è·å–æ–‡æ¡£å†…å®¹é•¿åº¦æ—¥å¿—å·²ç®€åŒ–
                return content;
            } catch (error) {
                showWpsErrorMessage('è·å–æ–‡æ¡£å†…å®¹å¤±è´¥', error);
                return null;
            }
        }
        
        // æå–Wordæ–‡æ¡£å†…å®¹
        function extractWordContent(doc) {
            try {
                let content = 'å½“å‰æ‰“å¼€çš„æ˜¯Wordæ–‡æ¡£ï¼Œæ ‡é¢˜ï¼š' + doc.Name + '\n\n';
                
                // å°è¯•è·å–æ–‡æ¡£å†…å®¹ï¼Œé™åˆ¶å¤„ç†èŒƒå›´ä»¥æé«˜æ€§èƒ½
                try {
                    const range = doc.Range(0, Math.min(doc.Content.End, 10000)); // é™åˆ¶è·å–èŒƒå›´
                    content += range.Text;
                } catch (rangeError) {
                    // å¦‚æœç›´æ¥è·å–Rangeå¤±è´¥ï¼Œå°è¯•æ®µè½æ–¹å¼è·å–
                    // ç›´æ¥è·å–Rangeå¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                    content += 'æ–‡æ¡£å†…å®¹ï¼š\n';
                    
                    const maxParagraphs = Math.min(doc.Paragraphs.Count, 200); // é™åˆ¶å¤„ç†æ®µè½æ•°
                    for (let i = 1; i <= maxParagraphs; i++) {
                        try {
                            const para = doc.Paragraphs.Item(i);
                            if (para && para.Range) {
                                content += para.Range.Text;
                            }
                        } catch (paraError) {
                            // è·å–æ®µè½å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                            content += '[æ— æ³•è·å–æ­¤æ®µè½]';
                        }
                    }
                    
                    if (doc.Paragraphs.Count > maxParagraphs) {
                        content += '\n...\n(æ–‡æ¡£è¿‡é•¿ï¼Œä»…æ˜¾ç¤ºéƒ¨åˆ†å†…å®¹)';
                    }
                }
                
                return content;
            } catch (e) {
                        // æå–Wordå†…å®¹å¤±è´¥é”™è¯¯å·²ç®€åŒ–
                        throw new Error(`Wordæ–‡æ¡£å¤„ç†å¤±è´¥: ${e.message}`);
            }
        }
        
        // æå–PowerPointæ–‡æ¡£å†…å®¹
        function extractPowerPointContent(doc) {
            try {
                let content = 'å½“å‰æ‰“å¼€çš„æ˜¯æ¼”ç¤ºæ–‡ç¨¿ï¼Œæ ‡é¢˜ï¼š' + doc.Name + '\n';
                content += 'å¹»ç¯ç‰‡æ•°é‡ï¼š' + doc.Slides.Count + '\n\n';
                
                // é™åˆ¶å¤„ç†çš„å¹»ç¯ç‰‡æ•°é‡ä»¥æé«˜æ€§èƒ½
                const maxSlides = Math.min(doc.Slides.Count, 5);
                
                for (let i = 1; i <= maxSlides; i++) {
                    try {
                        const slide = doc.Slides.Item(i);
                        content += `=== å¹»ç¯ç‰‡ ${i} ===\n`;
                        
                        // è·å–å¹»ç¯ç‰‡ä¸­çš„æ‰€æœ‰æ–‡æœ¬å†…å®¹
                        let slideText = '';
                        let hasText = false;
                        
                        for (let j = 1; j <= slide.Shapes.Count; j++) {
                            try {
                                const shape = slide.Shapes.Item(j);
                                if (shape.HasTextFrame && shape.TextFrame.HasText) {
                                    const text = shape.TextFrame.TextRange.Text.trim();
                                    if (text) {
                                        slideText += `- ${text}\n`;
                                        hasText = true;
                                    }
                                }
                            } catch (shapeError) {
                                // è·å–å½¢çŠ¶å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                            }
                        }
                        
                        content += hasText ? slideText : '[æ— æ–‡æœ¬å†…å®¹]\n';
                        content += '\n';
                    } catch (slideError) {
                        // è·å–å¹»ç¯ç‰‡å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                        content += `å¹»ç¯ç‰‡ ${i}: [æ— æ³•è·å–å†…å®¹]\n\n`;
                    }
                }
                
                if (doc.Slides.Count > maxSlides) {
                    content += `...\n(æ¼”ç¤ºæ–‡ç¨¿åŒ…å«æ›´å¤šå¹»ç¯ç‰‡ï¼Œä»…æ˜¾ç¤ºå‰${maxSlides}å¼ )`;
                }
                
                return content;
            } catch (e) {
                // æå–PowerPointå†…å®¹å¤±è´¥é”™è¯¯å·²ç®€åŒ–
                throw new Error(`æå–æ¼”ç¤ºæ–‡ç¨¿å†…å®¹æ—¶å‡ºé”™: ${e.message}`);
            }
        }
        
        // æå–Excelæ–‡æ¡£å†…å®¹
        function extractExcelContent(doc) {
            try {
                let content = 'å½“å‰æ‰“å¼€çš„æ˜¯Excelå·¥ä½œè¡¨ï¼Œæ ‡é¢˜ï¼š' + doc.Name + '\n';
                content += 'å·¥ä½œè¡¨æ•°é‡ï¼š' + doc.Worksheets.Count + '\n';
                
                // è·å–å½“å‰å·¥ä½œè¡¨ä¿¡æ¯
                const activeSheet = doc.ActiveSheet;
                content += 'å½“å‰å·¥ä½œè¡¨ï¼š' + (activeSheet.Name || 'æœªå‘½å') + '\n\n';
                
                try {
                    const usedRange = activeSheet.UsedRange;
                    const rows = Math.min(usedRange.Rows.Count, 15); // é™åˆ¶è¡Œæ•°
                    const cols = Math.min(usedRange.Columns.Count, 10); // é™åˆ¶åˆ—æ•°
                    
                    content += `æ•°æ®åŒºåŸŸé¢„è§ˆï¼š${rows}è¡Œ Ã— ${cols}åˆ—\n`;
                    content += '----------------------------------------\n';
                    
                    // æ·»åŠ æ•°æ®é¢„è§ˆ
                    for (let i = 1; i <= rows; i++) {
                        let rowContent = [];
                        for (let j = 1; j <= cols; j++) {
                            try {
                                const cell = usedRange.Cells.Item(i, j);
                                // å¤„ç†ä¸åŒç±»å‹çš„å€¼
                                let cellValue = cell.Value;
                                if (cellValue === null || cellValue === undefined) {
                                    cellValue = '';
                                } else if (typeof cellValue === 'string') {
                                    // é™åˆ¶å­—ç¬¦ä¸²é•¿åº¦
                                    cellValue = cellValue.length > 20 ? cellValue.substring(0, 20) + '...' : cellValue;
                                }
                                rowContent.push(cellValue);
                            } catch (cellError) {
                                rowContent.push('?');
                            }
                        }
                        content += rowContent.join('\t') + '\n';
                    }
                    
                    // å¦‚æœå®é™…æ•°æ®è¶…è¿‡æ˜¾ç¤ºèŒƒå›´ï¼Œæ·»åŠ æç¤º
                    if (usedRange.Rows.Count > rows || usedRange.Columns.Count > cols) {
                        content += '----------------------------------------\n';
                        content += `å®é™…æ•°æ®èŒƒå›´ï¼š${usedRange.Rows.Count}è¡Œ Ã— ${usedRange.Columns.Count}åˆ—\n`;
                        content += '(ä»…æ˜¾ç¤ºéƒ¨åˆ†æ•°æ®ä»¥æé«˜æ€§èƒ½)';
                    }
                } catch (rangeError) {
                    // è·å–Excelæ•°æ®åŒºåŸŸå¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                    content += '\n[æ— æ³•è·å–å·¥ä½œè¡¨æ•°æ®åŒºåŸŸï¼Œå¯èƒ½æ˜¯ç©ºå·¥ä½œè¡¨]';
                }
                
                return content;
            } catch (e) {
                // æå–Excelå†…å®¹å¤±è´¥é”™è¯¯å·²ç®€åŒ–
                throw new Error(`æå–å·¥ä½œè¡¨å†…å®¹æ—¶å‡ºé”™: ${e.message}`);
            }
        }
        
        // å‘WPSæ–‡æ¡£å†™å…¥å†…å®¹
        function writeToWpsDocument(content, append = false) {
            // å‚æ•°éªŒè¯
            if (!content || content.trim() === '') {
                showWpsErrorMessage('å†™å…¥å†…å®¹ä¸èƒ½ä¸ºç©º');
                return false;
            }
            
            if (!checkWpsAvailability()) {
                return showWpsErrorMessage('WPSç¯å¢ƒæœªè¿æ¥æˆ–æ— æ•ˆï¼Œæ— æ³•å†™å…¥æ–‡æ¡£å†…å®¹');
            }
            
            try {
                // ä½¿ç”¨tryWpsOperationå‡½æ•°è¿›è¡Œå¸¦é‡è¯•çš„æ“ä½œ
                const success = tryWpsOperation(() => {
                    // è·å–å½“å‰æ´»åŠ¨æ–‡æ¡£
                    // ä¸¥æ ¼æŒ‰ç…§JSAè§„èŒƒï¼Œä½¿ç”¨window.Application
const activeDocument = window.Application.ActiveDocument;
                    if (!activeDocument || !activeDocument.Name) {
                        throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ´»åŠ¨æ–‡æ¡£ï¼Œè¯·å…ˆæ‰“å¼€ä¸€ä¸ªWPSæ–‡æ¡£');
                    }
                    
                    // å†™å…¥æ–‡æ¡£æ¨¡å¼æ—¥å¿—å·²ç®€åŒ–
                    
                    // æ ¹æ®æ–‡æ¡£ç±»å‹å’Œæ¨¡å¼å†™å…¥å†…å®¹
                    if (activeDocument.Name.endsWith('.docx')) {
                        // å†…å®¹é•¿åº¦æ£€æŸ¥
                        if (content.length > 100000) {
                            throw new Error('å†™å…¥å†…å®¹è¿‡å¤§ï¼Œè¯·å°è¯•åˆ†æ®µå†™å…¥');
                        }
                        
                        if (append) {
                            // è¿½åŠ åˆ°æ–‡æ¡£æœ«å°¾
                            try {
                                const endPos = activeDocument.Content.End - 1;
                                activeDocument.Range(endPos, endPos).Text = '\n' + content;
                            } catch (appendError) {
                                // è¿½åŠ åˆ°æœ«å°¾å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                                // å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨InsertAfter
                                activeDocument.Content.InsertAfter('\n' + content);
                            }
                        } else {
                            // æ›¿æ¢æ•´ä¸ªæ–‡æ¡£å†…å®¹
                            activeDocument.Content.Text = content;
                        }
                        
                        // ä¿å­˜æ–‡æ¡£ä»¥ç¡®ä¿å†…å®¹è¢«å†™å…¥
                        try {
                            activeDocument.Save();
                            // Wordæ–‡æ¡£å·²ä¿å­˜æ—¥å¿—å·²ç®€åŒ–
                        } catch (saveError) {
                            // è‡ªåŠ¨ä¿å­˜å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                        }
                    }
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ¼”ç¤ºæ–‡ç¨¿
                    else if (activeDocument.Name && activeDocument.Name.endsWith('.pptx')) {
                        try {
                            // åœ¨æ¼”ç¤ºæ–‡ç¨¿ä¸­æ·»åŠ æ–°å¹»ç¯ç‰‡å¹¶å†™å…¥å†…å®¹
                            const newSlide = activeDocument.Slides.Add(activeDocument.Slides.Count + 1, 1);
                            
                            // æ·»åŠ æ ‡é¢˜
                            try {
                                const titleShape = newSlide.Shapes.Title;
                                if (titleShape && titleShape.TextFrame) {
                                    titleShape.TextFrame.TextRange.Text = 'AI ç”Ÿæˆå†…å®¹';
                                }
                            } catch (titleError) {
                                // è®¾ç½®æ ‡é¢˜å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                            }
                            
                            // æ·»åŠ å†…å®¹å½¢çŠ¶
                            try {
                                const slideWidth = activeDocument.PageSetup.SlideWidth;
                                const contentShape = newSlide.Shapes.AddTextbox(1, 100, 100, Math.min(slideWidth - 200, 600), 300);
                                contentShape.TextFrame.TextRange.Text = content;
                                contentShape.TextFrame.AutoSize = 1; // è‡ªåŠ¨è°ƒæ•´å¤§å°
                            } catch (shapeError) {
                                // æ·»åŠ å†…å®¹å½¢çŠ¶å¤±è´¥é”™è¯¯å·²ç®€åŒ–
                                throw new Error('æ— æ³•åœ¨æ¼”ç¤ºæ–‡ç¨¿ä¸­åˆ›å»ºå†…å®¹æ–‡æœ¬æ¡†');
                            }
                        } catch (slideError) {
                            // æ·»åŠ å¹»ç¯ç‰‡å¤±è´¥é”™è¯¯å·²ç®€åŒ–
                            throw new Error('æ— æ³•åœ¨æ¼”ç¤ºæ–‡ç¨¿ä¸­æ·»åŠ æ–°å¹»ç¯ç‰‡');
                        }
                    }
                    // æ£€æŸ¥æ˜¯å¦ä¸ºå·¥ä½œè¡¨
                    else if (activeDocument.Name && activeDocument.Name.endsWith('.xlsx')) {
                        try {
                            const activeSheet = activeDocument.ActiveSheet;
                            if (!activeSheet) {
                                throw new Error('æœªæ‰¾åˆ°æ´»åŠ¨å·¥ä½œè¡¨');
                            }
                            
                            // æ‰¾åˆ°æ­£ç¡®çš„èµ·å§‹è¡Œ
                            let startRow = 1;
                            if (append) {
                                try {
                                    const usedRange = activeSheet.UsedRange;
                                    startRow = usedRange.Rows.Count + 1;
                                } catch (rangeError) {
                                    // è·å–å·²ä½¿ç”¨èŒƒå›´å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                                    startRow = 1;
                                }
                            }
                            
                            // å†™å…¥å†…å®¹ï¼ˆé™åˆ¶è¡Œæ•°ï¼‰
                            const lines = content.split('\n');
                            const maxLines = Math.min(lines.length, 1000); // å®‰å…¨é™åˆ¶
                            
                            for (let i = 0; i < maxLines; i++) {
                                const line = lines[i];
                                try {
                                    // å¢å¼ºçš„æ•°æ®å¤„ç†
                                    let cellValue = line;
                                    // å°è¯•è½¬æ¢æ•°å­—
                                    if (!isNaN(line) && line.trim() !== '') {
                                        cellValue = parseFloat(line);
                                    }
                                    activeSheet.Cells.Item(startRow + i, 1).Value = cellValue;
                                } catch (cellError) {
                                    // å†™å…¥å•å…ƒæ ¼å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                                    // ç»§ç»­æ‰§è¡Œ
                                }
                            }
                            
                            // è‡ªåŠ¨è°ƒæ•´åˆ—å®½
                            try {
                                activeSheet.Columns(1).AutoFit();
                            } catch (autofitError) {
                                // è‡ªåŠ¨è°ƒæ•´åˆ—å®½å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                            }
                        } catch (excelError) {
                            // å†™å…¥Excelå¤±è´¥é”™è¯¯å·²ç®€åŒ–
                            throw new Error(`Excelæ“ä½œå¤±è´¥: ${excelError.message}`);
                        }
                    }
                    else {
                        throw new Error('ä¸æ”¯æŒçš„æ–‡æ¡£ç±»å‹ï¼š' + activeDocument.Name);
                    }
                    
                    return true;
                });
                
                if (success) {
                    // å†™å…¥æ–‡æ¡£æˆåŠŸæ—¥å¿—å·²ç®€åŒ–
                    addMessage('ai', 'å†…å®¹å·²æˆåŠŸå†™å…¥åˆ°æ–‡æ¡£ï¼š' + activeDocument.Name);
                    return true;
                }
                return false;
            } catch (error) {
                showWpsErrorMessage('å†™å…¥æ–‡æ¡£å†…å®¹å¤±è´¥', error);
                return false;
            }
        }
        
        // å¤„ç†ç‰¹æ®Šå‘½ä»¤
        // å¤„ç†å·¥ä½œç°¿é€‰æ‹©é€»è¾‘
        // æ³¨æ„ï¼šreferencedWorkbookå˜é‡å·²åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å£°æ˜
        
        // è·å–æ‰€æœ‰æ‰“å¼€çš„å·¥ä½œç°¿åç§°
        function getOpenWorkbooks() {
            try {
                // ä½¿ç”¨WPS APIè·å–å·¥ä½œç°¿åˆ—è¡¨
                // é¦–å…ˆå°è¯•ä½¿ç”¨WPSå…¨å±€å¯¹è±¡
                let wps = window.wps || window.Application;
                
                // å¦‚æœæ‰¾ä¸åˆ°WPSå¯¹è±¡ï¼Œå°è¯•è°ƒç”¨wpsLoadå‡½æ•°
                if (!wps && typeof window.wpsLoad === 'function') {
                    window.wpsLoad().then(api => {
                        // WPS APIåŠ è½½æˆåŠŸæ—¥å¿—å·²ç®€åŒ–
                    }).catch(error => {
                        // WPS APIåŠ è½½å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                    });
                }
                
                // å¦‚æœä»ç„¶æ²¡æœ‰WPSå¯¹è±¡ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®
                if (!wps || !wps.Application) {
                    // å¼€å‘ç¯å¢ƒæ¨¡æ‹Ÿæ•°æ®æ—¥å¿—å·²ç®€åŒ–
                    return [
                        'å·¥ä½œç°¿1.xlsx',
                        'å·¥ä½œç°¿2.xlsx', 
                        'å·¥ä½œç°¿3.xlsx'
                    ];
                }
                
                const workbooks = [];
                const application = wps.Application;
                
                // æ£€æŸ¥Workbooksé›†åˆæ˜¯å¦å­˜åœ¨
                if (application.Workbooks && application.Workbooks.Count > 0) {
                    const count = application.Workbooks.Count;
                    for (let i = 1; i <= count; i++) {
                        try {
                            // ä½¿ç”¨Itemæ–¹æ³•è·å–å·¥ä½œç°¿
                            const workbook = application.Workbooks.Item(i);
                            if (workbook && workbook.Name) {
                                workbooks.push(workbook.Name);
                            }
                        } catch (itemError) {
                            // è·å–ç¬¬Xä¸ªå·¥ä½œç°¿å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                        }
                    }
                }
                
                // å¦‚æœæ²¡æœ‰è·å–åˆ°å·¥ä½œç°¿ï¼Œè¿”å›è‡³å°‘ä¸€ä¸ªé»˜è®¤é¡¹
                if (workbooks.length === 0) {
                    workbooks.push('æ–°å»ºå·¥ä½œç°¿.xlsx');
                }
                
                return workbooks;
            } catch (error) {
                // è·å–å·¥ä½œç°¿åˆ—è¡¨å¤±è´¥æ—¥å¿—å·²ç®€åŒ–
                // è¿”å›æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡
                return [
                    'å·¥ä½œç°¿1.xlsx',
                    'å·¥ä½œç°¿2.xlsx',
                    'å·¥ä½œç°¿3.xlsx'
                ];
            }
        }
        

        
        // æ˜¾ç¤ºå·¥ä½œç°¿é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆå®æ—¶é€‰æ‹©æ¨¡å¼ï¼‰
        function showWorkbookSelectionDropdown() {
            const workbooks = getOpenWorkbooks();
            if (workbooks.length === 0) {
                addMessage('ai', 'æœªå‘ç°æ‰“å¼€çš„å·¥ä½œç°¿ï¼Œè¯·å…ˆæ‰“å¼€è¦å¼•ç”¨çš„å·¥ä½œç°¿ã€‚');
                return;
            }
            
            const dropdown = document.getElementById('workbookSelectDropdown');
            const optionsContainer = document.getElementById('workbookOptions');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            optionsContainer.innerHTML = '';
            
            // åˆ›å»ºé€‰é¡¹
            workbooks.forEach((workbook, index) => {
                const option = document.createElement('div');
                option.className = 'workbook-option';
                option.textContent = workbook;
                option.onclick = function() {
                    selectWorkbook(workbook);
                };
                optionsContainer.appendChild(option);
            });
            
            // æ˜¾ç¤ºä¸‹æ‹‰æ¡†
            dropdown.style.display = 'block';
            showWorkbookSelection = true;
            
            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­äº‹ä»¶
            document.addEventListener('click', handleOutsideClick);
            
            // æ˜¾ç¤ºå·¥ä½œç°¿é€‰æ‹©ä¸‹æ‹‰æ¡†æ—¥å¿—å·²ç®€åŒ–
        }
        
        // é€‰æ‹©å·¥ä½œç°¿
        function selectWorkbook(workbookName) {
            referencedWorkbook = workbookName;
            
            // éšè—ä¸‹æ‹‰æ¡†
            const dropdown = document.getElementById('workbookSelectDropdown');
            dropdown.style.display = 'none';
            showWorkbookSelection = false;
            
            // ç§»é™¤å¤–éƒ¨ç‚¹å‡»äº‹ä»¶
            document.removeEventListener('click', handleOutsideClick);
            
            // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤ºä¸ºå¸¦å¼•ç”¨å›¾æ ‡çš„å·¥ä½œç°¿åç§°ï¼Œä½¿ç”¨ç‰¹æ®Šé¢œè‰²
            const userInput = document.getElementById('userInput');
            userInput.value = '';
            userInput.style.color = ''; // é‡ç½®ä¸ºé»˜è®¤é¢œè‰²
            
            // æ·»åŠ å¼•ç”¨çŠ¶æ€ç±»å
            userInput.classList.add('referenced');
            
            // åœ¨è¾“å…¥æ¡†ä¸­æ·»åŠ å¼•ç”¨æ ‡è®°ï¼ˆä½¿ç”¨placeholderæ˜¾ç¤ºå›¾æ ‡å’Œæ–‡ä»¶åï¼‰
            userInput.placeholder = 'ğŸ“' + workbookName + ' ï¼ˆå·²å¼•ç”¨ï¼Œè¯·è¾“å…¥è¦å‘é€çš„èŠå¤©å†…å®¹ï¼‰';
            
            // è®¾ç½®ç„¦ç‚¹åˆ°è¾“å…¥æ¡†
            userInput.focus();
            
            // é‡ç½®è¾“å…¥ç›‘æ§çŠ¶æ€
            isTypingWorkbook = false;
            
            // é€‰æ‹©å·¥ä½œç°¿æ—¥å¿—å·²ç®€åŒ–
        }
        
        // å¤„ç†å¤–éƒ¨ç‚¹å‡»äº‹ä»¶
        function handleOutsideClick(event) {
            const dropdown = document.getElementById('workbookSelectDropdown');
            const userInput = document.getElementById('userInput');
            
            if (!dropdown.contains(event.target) && event.target !== userInput) {
                // éšè—ä¸‹æ‹‰æ¡†å¹¶æ¸…é™¤é€‰æ‹©çŠ¶æ€
                dropdown.style.display = 'none';
                showWorkbookSelection = false;
                document.removeEventListener('click', handleOutsideClick);
                
                // æ¸…é™¤è¾“å…¥æ¡†
                userInput.value = '';
            }
        }
        


        function handleSpecialCommands(message) {
            // ç§»é™¤é¦–å°¾ç©ºæ ¼ï¼Œç¡®ä¿å‘½ä»¤åŒ¹é…å‡†ç¡®
            const trimmedMessage = message.trim();
            
            if (message.startsWith('/è·å–æ–‡æ¡£å†…å®¹') || message.startsWith('/getdoc') || 
                trimmedMessage.startsWith('/è·å–æ–‡æ¡£å†…å®¹') || trimmedMessage.startsWith('/getdoc')) {
                const content = getWpsDocumentContent();
                if (content) {
                    // é™åˆ¶æ˜¾ç¤ºçš„å†…å®¹é•¿åº¦
                    const displayContent = content.length > 1000 ? content.substring(0, 1000) + '\n...\n(å†…å®¹è¿‡é•¿ï¼Œä»…æ˜¾ç¤ºå‰1000å­—ç¬¦)' : content;
                    addMessage('ai', 'å½“å‰æ–‡æ¡£å†…å®¹ï¼š\n```\n' + displayContent + '\n```');
                }
                return true;
            }
            
            if (message === '/å¼•ç”¨æ–‡ä»¶' || trimmedMessage === '/å¼•ç”¨æ–‡ä»¶') {
                // åªæœ‰å½“è¾“å…¥å®Œå…¨åŒ¹é…æ—¶æ‰è§¦å‘å·¥ä½œç°¿é€‰æ‹©
                showWorkbookSelectionDropdown();
                return true;
            }
            
            if (message.startsWith('/å†™å…¥æ–‡æ¡£') || trimmedMessage.startsWith('/å†™å…¥æ–‡æ¡£')) {
                const content = message.substring('/å†™å…¥æ–‡æ¡£'.length).trim();
                if (content) {
                    writeToWpsDocument(content, true);
                } else {
                    addMessage('ai', 'è¯·åœ¨å‘½ä»¤åè¾“å…¥è¦å†™å…¥çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š/å†™å…¥æ–‡æ¡£ è¿™æ˜¯è¦å†™å…¥çš„å†…å®¹');
                }
                return true;
            }
            
            if (message.startsWith('/æ¸…ç©ºæ–‡æ¡£') || trimmedMessage.startsWith('/æ¸…ç©ºæ–‡æ¡£')) {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰æ–‡æ¡£å†…å®¹å—ï¼Ÿ')) {
                    writeToWpsDocument('', false);
                }
                return true;
            }
            
            if (message.startsWith('/help') || message.startsWith('/å¸®åŠ©') || 
                trimmedMessage.startsWith('/help') || trimmedMessage.startsWith('/å¸®åŠ©')) {
                const helpText = 'æ”¯æŒçš„å‘½ä»¤ï¼š\n' +
                                '/å¼•ç”¨æ–‡ä»¶ - å¼•ç”¨å·¥ä½œç°¿ï¼Œå°†å·¥ä½œç°¿ä½œä¸ºé™„ä»¶ä¸Šä¼ åˆ°AIèŠå¤©å¤§æ¨¡å‹\n' +
                                '/è·å–æ–‡æ¡£å†…å®¹ æˆ– /getdoc - è·å–å½“å‰WPSæ–‡æ¡£çš„å†…å®¹\n' +
                                '/å†™å…¥æ–‡æ¡£ [å†…å®¹] - å°†å†…å®¹è¿½åŠ åˆ°å½“å‰æ–‡æ¡£\n' +
                                '/æ¸…ç©ºæ–‡æ¡£ - æ¸…ç©ºå½“å‰æ–‡æ¡£å†…å®¹ï¼ˆè¯·è°¨æ…ä½¿ç”¨ï¼‰\n' +
                                '/help æˆ– /å¸®åŠ© - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯';
                addMessage('ai', helpText);
                return true;
            }
            
            return false;
        }
        
        const chatBody = document.getElementById('chatBody');
        const userInput = document.getElementById('userInput');
        let chatHistory = [{ "role": "system", "content": "Always answer in Chinese." }];

        function handleKeyPress(event) {
            const userInput = document.getElementById('userInput');
            const currentValue = userInput.value;
            const commandDropdown = document.getElementById('commandDropdown');
            const isCommandDropdownVisible = commandDropdown && commandDropdown.style.display !== 'none';
            
            // å¦‚æœå‘½ä»¤ä¸‹æ‹‰æ¡†å¯è§ï¼Œå¤„ç†é”®ç›˜å¯¼èˆª
            if (isCommandDropdownVisible) {
                const commandOptions = commandDropdown.querySelectorAll('.command-option');
                let selectedIndex = -1;
                
                // æ‰¾åˆ°å½“å‰é€‰ä¸­çš„é€‰é¡¹
                for (let i = 0; i < commandOptions.length; i++) {
                    if (commandOptions[i].classList.contains('selected')) {
                        selectedIndex = i;
                        break;
                    }
                }
                
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    commandOptions.forEach(option => option.classList.remove('selected'));
                    // é€‰æ‹©ä¸‹ä¸€ä¸ªé€‰é¡¹
                    const nextIndex = selectedIndex < commandOptions.length - 1 ? selectedIndex + 1 : 0;
                    commandOptions[nextIndex].classList.add('selected');
                    commandOptions[nextIndex].scrollIntoView({ block: 'nearest' });
                    return;
                }
                
                if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    commandOptions.forEach(option => option.classList.remove('selected'));
                    // é€‰æ‹©ä¸Šä¸€ä¸ªé€‰é¡¹
                    const prevIndex = selectedIndex > 0 ? selectedIndex - 1 : commandOptions.length - 1;
                    commandOptions[prevIndex].classList.add('selected');
                    commandOptions[prevIndex].scrollIntoView({ block: 'nearest' });
                    return;
                }
                
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (selectedIndex >= 0) {
                        // é€‰æ‹©å½“å‰é€‰ä¸­çš„å‘½ä»¤
                        commandOptions[selectedIndex].click();
                        return;
                    }
                }
                
                if (event.key === 'Escape') {
                    event.preventDefault();
                    hideCommandDropdown();
                    return;
                }
            }
            
            // å®æ—¶ç›‘æ§è¾“å…¥æ¡†ï¼Œä»…å½“è¾“å…¥å®Œæ•´çš„"/å¼•ç”¨æ–‡ä»¶"æ—¶æ‰è§¦å‘å·¥ä½œç°¿é€‰æ‹©
            if (currentValue === '/å¼•ç”¨æ–‡ä»¶') {
                if (workbookSelectTimeout) {
                    clearTimeout(workbookSelectTimeout);
                }
                workbookSelectTimeout = setTimeout(() => {
                    if (!showWorkbookSelection) {
                        hideCommandDropdown();
                        showWorkbookSelectionDropdown();
                    }
                }, 500);
                return;
            }
            
            // Ctrl+Enteræ¢è¡Œï¼ŒEnterå‘é€æ¶ˆæ¯ï¼ˆä»…å½“ä¸‹æ‹‰æ¡†ä¸å¯è§æ—¶ï¼‰
            if (event.ctrlKey && event.key === 'Enter') {
                // Ctrl+Enteræ’å…¥æ¢è¡Œç¬¦
                const start = userInput.selectionStart;
                const end = userInput.selectionEnd;
                userInput.value = currentValue.substring(0, start) + '\n' + currentValue.substring(end);
                userInput.selectionStart = userInput.selectionEnd = start + 1;
                return;
            }
            
            if (event.key === 'Enter' && !isCommandDropdownVisible && !event.shiftKey) {
                sendMessage();
            }
        }

        // é€šç”¨APIè°ƒç”¨å‡½æ•°ï¼Œæ”¯æŒå¤šä¸ªç«¯ç‚¹
        function callApi(endpoint, method, data, onSuccess, onError) {
            // ç¡®ä¿é…ç½®å·²åŠ è½½
            let currentConfig = window.CURRENT_AI_CONFIG || window.AI_CONFIG;
            if (!currentConfig) {
                // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
                console.error('âŒ æœªæ‰¾åˆ°AIé…ç½®ï¼Œè¯·æ£€æŸ¥server-config.txtæ˜¯å¦æ­£ç¡®åŠ è½½');
                if (onError) onError(new Error('æœªæ‰¾åˆ°AIé…ç½®ï¼Œè¯·æ£€æŸ¥server-config.txtæ˜¯å¦æ­£ç¡®åŠ è½½'));
                return;
            }
            

            
            let apiUrl;
            if (currentConfig.baseURL) {
                // ä½¿ç”¨æ ‡å‡†OpenAIæ ¼å¼API
                let baseUrl = currentConfig.baseURL;
                if (baseUrl.endsWith('/')) {
                    baseUrl = baseUrl.slice(0, -1);
                }
                // æ£€æŸ¥baseUrlæ˜¯å¦å·²ç»åŒ…å«APIè·¯å¾„
                if (baseUrl.includes('/v1') || baseUrl.includes('/chat') || baseUrl.includes('/completions')) {
                    // å¦‚æœbaseUrlå·²ç»åŒ…å«è·¯å¾„ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
                    apiUrl = baseUrl;
                } else {
                    // å¦åˆ™æ·»åŠ endpointè·¯å¾„
                    apiUrl = `${baseUrl}${endpoint}`;
                }
            } else if (currentConfig.apiEndpoint) {
                // ä½¿ç”¨å±€åŸŸç½‘APIç«¯ç‚¹
                let endpointUrl = currentConfig.apiEndpoint;
                // å¦‚æœapiEndpointå·²åŒ…å«è·¯å¾„éƒ¨åˆ†ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
                if (endpointUrl.includes('/v1') || endpointUrl.includes('/chat/completions')) {
                    apiUrl = endpointUrl;
                } else {
                    // å¦åˆ™æ·»åŠ endpointè·¯å¾„
                    apiUrl = `${endpointUrl}${endpoint}`;
                }
            } else {
                // ä½¿ç”¨é»˜è®¤åœ°å€
                apiUrl = `http://192.168.70.26:1234${endpoint}`;
            }
            
            console.log('ğŸš€ å‘é€APIè¯·æ±‚åˆ°:', apiUrl);
            
            // æ£€æŸ¥æ˜¯å¦åœ¨WPSç¯å¢ƒä¸­
            if (window.wps || window.Application) {
                // å°Šé‡ç”¨æˆ·é…ç½®ï¼Œåªæœ‰å½“ç”¨æˆ·æ˜ç¡®é…ç½®ä¸ºä½¿ç”¨å±€åŸŸç½‘æ—¶æ‰ä½¿ç”¨å±€åŸŸç½‘é…ç½®
                if (window.AI_CONFIG_TYPE === 'AI_CONFIG_WLAN' && window.AI_CONFIG_WLAN && window.AI_CONFIG_WLAN.apiEndpoint) {
                    // ç”¨æˆ·é…ç½®ä¸ºä½¿ç”¨å±€åŸŸç½‘AIæœåŠ¡
                    let wlanBaseUrl = window.AI_CONFIG_WLAN.apiEndpoint;
                    if (wlanBaseUrl && wlanBaseUrl.includes('/v1') && !endpoint.includes('/v1')) {
                        apiUrl = wlanBaseUrl;
                        currentConfig = window.AI_CONFIG_WLAN;
                    } else if (wlanBaseUrl && !wlanBaseUrl.includes('/v1')) {
                        apiUrl = `${wlanBaseUrl}${endpoint}`;
                        currentConfig = window.AI_CONFIG_WLAN;
                    }
                    console.log('ğŸ  æ ¹æ®ç”¨æˆ·é…ç½®ï¼Œä½¿ç”¨å±€åŸŸç½‘AIæœåŠ¡:', apiUrl);
                } else {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å±€åŸŸç½‘åœ°å€ä½†è¿æ¥å¤±è´¥çš„æƒ…å†µ
                    if (apiUrl.includes('192.168') && window._LAST_CONNECTION_FAILED) {
                        // å¦‚æœä¸Šæ¬¡è¿æ¥å±€åŸŸç½‘å¤±è´¥äº†ï¼Œå°è¯•ä½¿ç”¨äº‘ç«¯é…ç½®
                        if (window.AI_CONFIG && window.AI_CONFIG.baseURL) {
                            currentConfig = window.AI_CONFIG;
                            let baseUrl = currentConfig.baseURL;
                            if (baseUrl.endsWith('/')) {
                                baseUrl = baseUrl.slice(0, -1);
                            }
                            apiUrl = `${baseUrl}${endpoint}`;
                            console.log('ğŸ  å±€åŸŸç½‘è¿æ¥å¤±è´¥ï¼Œåˆ‡æ¢åˆ°äº‘ç«¯AIæœåŠ¡:', apiUrl);
                        }
                    }
                }
                
                // åœ¨WPSç¯å¢ƒä¸­ï¼Œä¼˜å…ˆä½¿ç”¨enhancedAIInterfaceï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–WPSå†…ç½®åŠŸèƒ½
                if (window.enhancedAIInterface) {
                    console.log('ğŸš€ ä½¿ç”¨å¢å¼ºAIæ¥å£');
                    // å¦‚æœæ˜¯é˜¿é‡Œäº‘APIï¼Œå°è¯•ä½¿ç”¨WPSå†…ç½®åŠŸèƒ½é¿å…CORSé—®é¢˜
                    if (apiUrl.includes('dashscope.aliyuncs.com')) {
                        console.log('â˜ï¸ æ£€æµ‹åˆ°é˜¿é‡Œäº‘APIï¼Œå°è¯•ä½¿ç”¨WPSå†…ç½®åŠŸèƒ½');
                        callApiViaXmlHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                    } else {
                        callApiViaEnhancedAIInterface(currentConfig, apiUrl, method, data, onSuccess, onError);
                    }
                } else {
                    // å¦åˆ™å°è¯•ä½¿ç”¨WPSå†…ç½®åŠŸèƒ½
                    callApiViaXmlHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                }
            } else {
                // åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œä½¿ç”¨fetch API
                callApiViaFetch(currentConfig, apiUrl, method, data, onSuccess, onError);
            }
        }
        
        // é€šè¿‡WPS APIè°ƒç”¨APIï¼ˆç”¨äºç»•è¿‡CORSé™åˆ¶ï¼‰
        function callApiViaWps(currentConfig, apiUrl, method, data, onSuccess, onError) {
            try {
                console.log('ğŸ“¡ æ£€æŸ¥WPSå†…ç½®ç½‘ç»œåŠŸèƒ½');
                
                // åœ¨WPS JSAç¯å¢ƒä¸­ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨Applicationå¯¹è±¡
                if (window.Application && typeof window.Application.Invoke !== 'undefined') {
                    // å°è¯•ä½¿ç”¨WPSçš„Invokeæ–¹æ³•æ‰§è¡ŒHTTPè¯·æ±‚
                    console.log('å°è¯•ä½¿ç”¨WPS Invokeæ–¹æ³•');
                    
                    // åˆ›å»ºä¸€ä¸ªWPSå®æˆ–VBAè„šæœ¬æ¥æ‰§è¡ŒHTTPè¯·æ±‚
                    // ä½†è¿™éœ€è¦åœ¨WPSç¯å¢ƒä¸­æ‰§è¡Œ
                    
                    // é¦–å…ˆå°è¯•ä½¿ç”¨WPSçš„ShellExecuteæˆ–Runæ–¹æ³•æ¥è°ƒç”¨å¤–éƒ¨ç¨‹åºæ‰§è¡Œè¯·æ±‚
                    if (window.Application.ShellExecute) {
                        console.log('WPS ShellExecuteæ–¹æ³•ä¸å¯ç”¨äºHTTPè¯·æ±‚');
                    }
                    
                    // å¦‚æœWPSä¸æ”¯æŒç›´æ¥çš„HTTPè¯·æ±‚ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨å…¶ä»–æ–¹å¼
                    // æœ€å¥½çš„æ–¹å¼æ˜¯åœ¨WPSç¯å¢ƒä¸­å¯åŠ¨ä¸€ä¸ªæœ¬åœ°ä»£ç†
                    console.log('WPSç¯å¢ƒä¸æ”¯æŒç›´æ¥çš„HTTPè¯·æ±‚ï¼Œæç¤ºç”¨æˆ·é…ç½®æœ¬åœ°ä»£ç†æˆ–ä½¿ç”¨å±€åŸŸç½‘AIæœåŠ¡');
                    
                    // æ£€æŸ¥æ˜¯å¦é…ç½®äº†å±€åŸŸç½‘AIæœåŠ¡
                    if (currentConfig.apiEndpoint && currentConfig.apiEndpoint.startsWith('http://192.168.')) {
                        console.log('æ£€æµ‹åˆ°å±€åŸŸç½‘AIæœåŠ¡é…ç½®ï¼Œå°è¯•ä½¿ç”¨fetch');
                        // å¯¹äºå±€åŸŸç½‘è¯·æ±‚ï¼ŒCORSé™åˆ¶å¯èƒ½è¾ƒå®½æ¾
                        callApiViaFetch(currentConfig, apiUrl, method, data, onSuccess, onError);
                    } else {
                        // å¦‚æœæ˜¯å¤–éƒ¨APIï¼Œæç¤ºç”¨æˆ·é…ç½®æœ¬åœ°ä»£ç†
                        onError(new Error('WPSç¯å¢ƒæ— æ³•ç›´æ¥è®¿é—®å¤–éƒ¨APIã€‚è¯·é…ç½®å±€åŸŸç½‘AIæœåŠ¡æˆ–è®¾ç½®æœ¬åœ°APIä»£ç†ã€‚'));
                    }
                    
                    return;
                } else {
                    // å¦‚æœä¸åœ¨WPSç¯å¢ƒä¸­ï¼Œç›´æ¥ä½¿ç”¨fetch
                    console.log('ä¸åœ¨WPSç¯å¢ƒä¸­ï¼Œä½¿ç”¨fetch API');
                    callApiViaFetch(currentConfig, apiUrl, method, data, onSuccess, onError);
                    return;
                }
            } catch (error) {
                console.error('âŒ WPS HTTPåŠŸèƒ½æ£€æŸ¥å¤±è´¥:', error);
                console.log('ğŸ”„ å›é€€åˆ°fetch API');
                // å¦‚æœWPS HTTPåŠŸèƒ½ä¸å¯ç”¨ï¼Œå›é€€åˆ°fetch
                callApiViaFetch(currentConfig, apiUrl, method, data, onSuccess, onError);
            }
        }
        
        // é€šè¿‡XMLHttpRequestè°ƒç”¨API
        function callApiViaXHR(currentConfig, apiUrl, method, data, onSuccess, onError) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, apiUrl);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            // æ ¹æ®é…ç½®è®¾ç½®è®¤è¯å¤´
            if (currentConfig.apiKey) {
                xhr.setRequestHeader('Authorization', `Bearer ${currentConfig.apiKey}`);
            }
            
            xhr.onload = function() {
                console.log('ğŸ“Š APIå“åº”çŠ¶æ€:', xhr.status);
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        console.log('âœ… APIè¯·æ±‚æˆåŠŸ');
                        if (onSuccess) onSuccess(response);
                    } catch (error) {
                        console.error('âŒ å“åº”è§£æå¤±è´¥:', error);
                        if (onError) onError(new Error('è§£æå“åº”å¤±è´¥: ' + error.message));
                    }
                } else {
                    console.error('âŒ APIè¯·æ±‚å¤±è´¥:', xhr.status, xhr.statusText);
                    // å°è¯•è·å–é”™è¯¯è¯¦æƒ…
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (onError) onError(new Error(`APIè¯·æ±‚å¤±è´¥ (${xhr.status}): ${JSON.stringify(errorResponse)}`));
                    } catch (parseError) {
                        if (onError) onError(new Error(`APIè¯·æ±‚å¤±è´¥ (${xhr.status}): ${xhr.statusText}`));
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('âŒ ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨:', apiUrl);
                // å°è¯•ä½¿ç”¨fetchä½œä¸ºå›é€€æ–¹æ¡ˆ
                console.log('ğŸ”„ å°è¯•ä½¿ç”¨fetchä½œä¸ºå›é€€æ–¹æ¡ˆ');
                callApiViaFetch(currentConfig, apiUrl, method, data, onSuccess, onError);
            };
            
            if (data) {
                console.log('ğŸ“¤ å‘é€è¯·æ±‚æ•°æ®:', JSON.stringify(data, null, 2));
                xhr.send(JSON.stringify(data));
            } else {
                xhr.send();
            }
        }
        
        // é€šè¿‡fetchè°ƒç”¨APIï¼ˆç°ä»£æµè§ˆå™¨æ–¹æ³•ï¼Œæœ‰æ—¶å¯ä»¥ç»•è¿‡æŸäº›CORSé™åˆ¶ï¼‰
        function callApiViaFetch(currentConfig, apiUrl, method, data, onSuccess, onError) {
            console.log('ğŸŒ ä½¿ç”¨fetch APIå‘é€è¯·æ±‚');
            
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // æ ¹æ®é…ç½®è®¾ç½®è®¤è¯å¤´
            if (currentConfig.apiKey) {
                headers['Authorization'] = `Bearer ${currentConfig.apiKey}`;
            }
            
            const options = {
                method: method,
                headers: headers,
                body: data ? JSON.stringify(data) : undefined
            };
            
            fetch(apiUrl, options)
                .then(response => {
                    console.log('ğŸ“Š Fetchå“åº”çŠ¶æ€:', response.status);
                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.text().then(text => {
                            throw new Error(`APIè¯·æ±‚å¤±è´¥ (${response.status}): ${text}`);
                        });
                    }
                })
                .then(result => {
                    console.log('âœ… Fetch APIè¯·æ±‚æˆåŠŸ');
                    onSuccess(result);
                })
                .catch(error => {
                    console.error('âŒ Fetch APIè¯·æ±‚å¤±è´¥:', error);
                    // å¦‚æœfetchä¹Ÿå¤±è´¥ï¼Œæœ€åå°è¯•ä»£ç†
                    callApiViaProxy(currentConfig, apiUrl, method, data, onSuccess, onError);
                });
        }
        
        // é€šè¿‡WPSå†…éƒ¨ä»£ç†è°ƒç”¨APIï¼ˆæœ€ç»ˆå›é€€æ–¹æ¡ˆï¼‰
        function callApiViaProxy(currentConfig, apiUrl, method, data, onSuccess, onError) {
            console.log('ğŸ”Œ å°è¯•ä½¿ç”¨WPSä»£ç†API');
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨WPSçš„Applicationå¯¹è±¡è¿›è¡Œç½‘ç»œè¯·æ±‚
            if (window.Application && typeof window.Application.HttpRequest !== 'undefined') {
                try {
                    // ä½¿ç”¨WPSå†…ç½®çš„HTTPè¯·æ±‚åŠŸèƒ½
                    const httpRequest = window.Application.HttpRequest;
                    
                    // è®¾ç½®è¯·æ±‚å‚æ•°
                    httpRequest.Open(method, apiUrl);
                    httpRequest.SetRequestHeader('Content-Type', 'application/json');
                    
                    if (currentConfig.apiKey) {
                        httpRequest.SetRequestHeader('Authorization', `Bearer ${currentConfig.apiKey}`);
                    }
                    
                    // å‘é€è¯·æ±‚
                    httpRequest.Send(data ? JSON.stringify(data) : '');
                    
                    if (httpRequest.Status >= 200 && httpRequest.Status < 300) {
                        const response = JSON.parse(httpRequest.ResponseText);
                        onSuccess(response);
                    } else {
                        onError(new Error(`ä»£ç†APIè¯·æ±‚å¤±è´¥ (${httpRequest.Status}): ${httpRequest.StatusText}`));
                    }
                } catch (proxyError) {
                    console.error('âŒ WPSä»£ç†APIè°ƒç”¨å¤±è´¥:', proxyError);
                    
                    // å°è¯•ä½¿ç”¨XMLHttpRequestï¼ˆWPSç¯å¢ƒå¯èƒ½æ”¯æŒï¼‰
                    callApiViaXmlHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                }
            } else {
                // å°è¯•ä½¿ç”¨XMLHttpRequestï¼ˆWPSç¯å¢ƒå¯èƒ½æ”¯æŒï¼‰
                callApiViaXmlHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
            }
        }
        
        // ä½¿ç”¨enhancedAIInterfaceè°ƒç”¨APIï¼ˆWPSç¯å¢ƒé¦–é€‰ï¼‰
        function callApiViaEnhancedAIInterface(currentConfig, apiUrl, method, data, onSuccess, onError) {
            console.log('ğŸ“¡ å°è¯•ä½¿ç”¨å¢å¼ºAIæ¥å£');
            
            try {
                // æ£€æŸ¥æ˜¯å¦åœ¨WPSç¯å¢ƒä¸­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°è¯•ä½¿ç”¨WPSå†…ç½®åŠŸèƒ½
                if (window.Application && window.Application.HttpRequest) {
                    // ä½¿ç”¨WPSçš„å†…ç½®HttpRequeståŠŸèƒ½
                    console.log('ğŸ”Œ åœ¨WPSç¯å¢ƒä¸­ä½¿ç”¨WPSå†…ç½®HttpRequest');
                    callApiViaWpsHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                } else {
                    // é’ˆå¯¹é˜¿é‡Œäº‘DashScope APIï¼Œä¿®æ”¹è¯·æ±‚æ ¼å¼
                    let modifiedData = data;
                    if (apiUrl.includes('dashscope.aliyuncs.com')) {
                        // å¯¹äºé˜¿é‡Œäº‘APIï¼Œç¡®ä¿ä¸åŒ…å«ä¸å…¼å®¹çš„æµå¼å‚æ•°
                        modifiedData = {...data};
                        if (modifiedData.stream !== undefined) {
                            delete modifiedData.stream; // åˆ é™¤streamå‚æ•°
                        }
                        // å¦‚æœæœ‰X-DashScope-SSEå¤´éƒ¨ï¼Œä¹Ÿéœ€è¦ç›¸åº”å¤„ç†
                    }
                    
                    // ä½¿ç”¨enhancedAIInterfaceçš„handleAIApiRequestæ–¹æ³•
                    window.enhancedAIInterface.handleAIApiRequest(apiUrl, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentConfig.apiKey}`
                        },
                        body: JSON.stringify(modifiedData)
                    }).then(function(response) {
                        // è¯·æ±‚æˆåŠŸï¼Œæ¸…é™¤è¿æ¥å¤±è´¥æ ‡è®°
                        window._LAST_CONNECTION_FAILED = false;
                        console.log('âœ… å¢å¼ºAIæ¥å£è¯·æ±‚æˆåŠŸ');
                        onSuccess(response);
                    }).catch(function(error) {
                        // é™é»˜å¤„ç†CORSé”™è¯¯ï¼Œåªè®°å½•å¿…è¦ä¿¡æ¯
                        if (apiUrl.includes('dashscope.aliyuncs.com')) {
                            console.log('âš ï¸ é˜¿é‡Œäº‘APIè¿æ¥å—é™');
                        } else {
                            console.error('âŒ å¢å¼ºAIæ¥å£è¯·æ±‚å¤±è´¥:', error);
                        }
                        
                        // å¦‚æœæ˜¯è¿æ¥è¢«æ‹’ç»é”™è¯¯ï¼Œå°è¯•å›é€€åˆ°äº‘ç«¯é…ç½®
                        if (error.message.includes('ERR_CONNECTION_REFUSED') || error.message.includes('ç½‘ç»œè¯·æ±‚å¤±è´¥')) {
                            // æ ‡è®°è¿æ¥å¤±è´¥
                            window._LAST_CONNECTION_FAILED = true;
                            console.log('âš ï¸ ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå°è¯•å›é€€');
                            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº‘ç«¯é…ç½®
                            if (window.AI_CONFIG && window.AI_CONFIG.baseURL) {
                                callApiViaEnhancedAIInterface(window.AI_CONFIG, 
                                    window.AI_CONFIG.baseURL + '/chat/completions', 
                                    method, data, onSuccess, onError);
                            } else {
                                // å¦‚æœæ²¡æœ‰äº‘ç«¯é…ç½®ï¼Œå°è¯•WPSå†…ç½®åŠŸèƒ½
                                if (window.Application && window.Application.HttpRequest) {
                                    callApiViaWpsHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                                } else {
                                    callApiViaXmlHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                                }
                            }
                        } else {
                            // å›é€€åˆ°WPS HttpRequestæˆ–XMLHttpRequest
                            if (window.Application && window.Application.HttpRequest) {
                                callApiViaWpsHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                            } else {
                                callApiViaXmlHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('âŒ å¢å¼ºAIæ¥å£è°ƒç”¨å¤±è´¥:', error);
                // å›é€€åˆ°WPS HttpRequestæˆ–XMLHttpRequest
                if (window.Application && window.Application.HttpRequest) {
                    callApiViaWpsHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                } else {
                    callApiViaXmlHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError);
                }
            }
        }
        
        // ä½¿ç”¨WPSå†…ç½®HttpRequestè°ƒç”¨API
        function callApiViaWpsHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError) {
            console.log('ğŸ“¡ å°è¯•ä½¿ç”¨WPSå†…ç½®HttpRequest');
            
            try {
                // æ£€æŸ¥WPS Applicationå¯¹è±¡æ˜¯å¦å¯ç”¨
                if (!window.Application) {
                    throw new Error('WPS Applicationå¯¹è±¡ä¸å¯ç”¨');
                }
                
                // å°è¯•ä½¿ç”¨WPSå†…ç½®çš„ç½‘ç»œåŠŸèƒ½
                // åœ¨WPS JSAç¯å¢ƒä¸­ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„æ–¹æ³•
                
                // å°è¯•ä½¿ç”¨ActiveXObjectè¿›è¡ŒHTTPè¯·æ±‚
                if (typeof window.ActiveXObject !== 'undefined') {
                    const xmlHttp = new ActiveXObject('MSXML2.XMLHTTP');
                    
                    xmlHttp.open(method, apiUrl, true); // å¼‚æ­¥è¯·æ±‚
                    
                    // è®¾ç½®è¯·æ±‚å¤´
                    xmlHttp.setRequestHeader('Content-Type', 'application/json');
                    if (currentConfig.apiKey) {
                        xmlHttp.setRequestHeader('Authorization', `Bearer ${currentConfig.apiKey}`);
                    }
                    
                    xmlHttp.onreadystatechange = function() {
                        if (xmlHttp.readyState === 4) { // è¯·æ±‚å®Œæˆ
                            if (xmlHttp.status >= 200 && xmlHttp.status < 300) {
                                // è¯·æ±‚æˆåŠŸï¼Œæ¸…é™¤è¿æ¥å¤±è´¥æ ‡è®°
                                window._LAST_CONNECTION_FAILED = false;
                                try {
                                    const response = JSON.parse(xmlHttp.responseText);
                                    console.log('âœ… WPS ActiveXObjectè¯·æ±‚æˆåŠŸ');
                                    onSuccess(response);
                                } catch (parseError) {
                                    console.error('âŒ WPSå“åº”è§£æå¤±è´¥:', parseError);
                                    onError(new Error('å“åº”è§£æå¤±è´¥: ' + parseError.message));
                                }
                            } else {
                                // é’ˆå¯¹é˜¿é‡Œäº‘APIçš„ç‰¹æ®Šå¤„ç†ï¼š400é”™è¯¯å¯èƒ½æ˜¯è¯·æ±‚æ ¼å¼é—®é¢˜
                                if (xmlHttp.status === 400 && apiUrl.includes('dashscope.aliyuncs.com')) {
                                    console.error('âŒ é˜¿é‡Œäº‘APIè¯·æ±‚é”™è¯¯:', xmlHttp.status, xmlHttp.statusText);
                                    console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', xmlHttp.responseText);
                                    onError(new Error(`é˜¿é‡Œäº‘APIè¯·æ±‚é”™è¯¯ (${xmlHttp.status}): ${xmlHttp.statusText} - ${xmlHttp.responseText}`));
                                } else if (xmlHttp.status === 0 || xmlHttp.statusText.includes('Error')) {
                                    // å¦‚æœæ˜¯è¿æ¥è¢«æ‹’ç»é”™è¯¯ï¼Œå°è¯•å›é€€åˆ°äº‘ç«¯é…ç½®
                                    // æ ‡è®°è¿æ¥å¤±è´¥
                                    window._LAST_CONNECTION_FAILED = true;
                                    console.log('âš ï¸ å±€åŸŸç½‘AIæœåŠ¡ä¸å¯ç”¨ï¼Œå°è¯•å›é€€åˆ°äº‘ç«¯AIæœåŠ¡');
                                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº‘ç«¯é…ç½®
                                    if (window.AI_CONFIG && window.AI_CONFIG.baseURL) {
                                        console.log('ğŸ”„ åˆ‡æ¢åˆ°äº‘ç«¯AIæœåŠ¡');
                                        callApiViaWpsHttpRequest(window.AI_CONFIG, 
                                            window.AI_CONFIG.baseURL + '/chat/completions', 
                                            method, data, onSuccess, onError);
                                    } else {
                                        console.error('âŒ WPS ActiveXObjectè¯·æ±‚å¤±è´¥:', xmlHttp.status, xmlHttp.statusText);
                                        onError(new Error(`APIè¯·æ±‚å¤±è´¥ (${xmlHttp.status}): ${xmlHttp.statusText}`));
                                    }
                                } else {
                                    console.error('âŒ WPS ActiveXObjectè¯·æ±‚å¤±è´¥:', xmlHttp.status, xmlHttp.statusText);
                                    onError(new Error(`APIè¯·æ±‚å¤±è´¥ (${xmlHttp.status}): ${xmlHttp.statusText}`));
                                }
                            }
                        }
                    };
                    
                    xmlHttp.onerror = function() {
                        // é’ˆå¯¹é˜¿é‡Œäº‘APIçš„é”™è¯¯å¤„ç†
                        if (apiUrl.includes('dashscope.aliyuncs.com')) {
                            // å®Œå…¨é™é»˜å¤„ç†CORSé”™è¯¯ï¼Œä¸åœ¨æ§åˆ¶å°è¾“å‡ºæ•æ„Ÿä¿¡æ¯
                            onError(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥')); 
                        } else {
                            // æ£€æŸ¥æ˜¯å¦å¯ä»¥å›é€€åˆ°äº‘ç«¯é…ç½®
                            console.log('âš ï¸ ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå°è¯•å›é€€');
                            if (window.AI_CONFIG && window.AI_CONFIG.baseURL) {
                                callApiViaWpsHttpRequest(window.AI_CONFIG, 
                                    window.AI_CONFIG.baseURL + '/chat/completions', 
                                    method, data, onSuccess, onError);
                            } else {
                                onError(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥'));
                            }
                        }
                    };
                    
                    // å‘é€è¯·æ±‚
                    xmlHttp.send(data ? JSON.stringify(data) : null);
                    
                } else {
                    throw new Error('WPSç¯å¢ƒä¸­ä¸æ”¯æŒActiveXObject');
                }
                
            } catch (error) {
                console.error('âŒ WPS HttpRequestè°ƒç”¨å¤±è´¥:', error);
                // å¦‚æœæ˜¯è¿æ¥é”™è¯¯ï¼Œå°è¯•å›é€€åˆ°äº‘ç«¯é…ç½®
                if (error.message.includes('Connection refused') || error.message.includes('ç½‘ç»œé”™è¯¯')) {
                    console.log('âš ï¸ å±€åŸŸç½‘AIæœåŠ¡ä¸å¯ç”¨ï¼Œå°è¯•å›é€€åˆ°äº‘ç«¯AIæœåŠ¡');
                    if (window.AI_CONFIG && window.AI_CONFIG.baseURL) {
                        console.log('ğŸ”„ åˆ‡æ¢åˆ°äº‘ç«¯AIæœåŠ¡');
                        callApiViaWpsHttpRequest(window.AI_CONFIG, 
                            window.AI_CONFIG.baseURL + '/chat/completions', 
                            method, data, onSuccess, onError);
                    } else {
                        onError(new Error('WPS HttpRequestè°ƒç”¨å¤±è´¥: ' + error.message));
                    }
                } else {
                    onError(new Error('WPS HttpRequestè°ƒç”¨å¤±è´¥: ' + error.message));
                }
            }
        }
        
        // ä½¿ç”¨XMLHttpRequestè°ƒç”¨APIï¼ˆé€‚ç”¨äºWPSç¯å¢ƒï¼‰
        function callApiViaXmlHttpRequest(currentConfig, apiUrl, method, data, onSuccess, onError) {
            console.log('ğŸ“¡ å°è¯•ä½¿ç”¨XMLHttpRequest');
            
            try {
                let xhr;
                if (window.XMLHttpRequest) {
                    xhr = new XMLHttpRequest();
                } else if (window.ActiveXObject) {
                    // å…¼å®¹æ—§ç‰ˆIE
                    xhr = new ActiveXObject('Microsoft.XMLHTTP');
                } else {
                    throw new Error('å½“å‰ç¯å¢ƒä¸æ”¯æŒXMLHttpRequest');
                }
                
                xhr.open(method, apiUrl, true);
                
                // è®¾ç½®è¯·æ±‚å¤´
                xhr.setRequestHeader('Content-Type', 'application/json');
                if (currentConfig.apiKey) {
                    xhr.setRequestHeader('Authorization', `Bearer ${currentConfig.apiKey}`);
                }
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) { // è¯·æ±‚å®Œæˆ
                        if (xhr.status >= 200 && xhr.status < 300) {
                            // è¯·æ±‚æˆåŠŸï¼Œæ¸…é™¤è¿æ¥å¤±è´¥æ ‡è®°
                            window._LAST_CONNECTION_FAILED = false;
                            try {
                                const response = JSON.parse(xhr.responseText);
                                console.log('âœ… XMLHttpRequestè¯·æ±‚æˆåŠŸ');
                                onSuccess(response);
                            } catch (parseError) {
                                console.error('âŒ å“åº”è§£æå¤±è´¥:', parseError);
                                onError(new Error('å“åº”è§£æå¤±è´¥: ' + parseError.message));
                            }
                        } else {
                            // é’ˆå¯¹é˜¿é‡Œäº‘APIçš„ç‰¹æ®Šå¤„ç†ï¼š400é”™è¯¯å¯èƒ½æ˜¯è¯·æ±‚æ ¼å¼é—®é¢˜
                            if (xhr.status === 400 && apiUrl.includes('dashscope.aliyuncs.com')) {
                                console.log('âš ï¸ é˜¿é‡Œäº‘APIå‚æ•°é—®é¢˜:', xhr.status, xhr.statusText);
                                console.log('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', xhr.responseText);
                                onError(new Error(`é˜¿é‡Œäº‘APIå‚æ•°é”™è¯¯`));
                            } else if (xhr.status === 0 || xhr.statusText.includes('Error')) {
                                // å¦‚æœæ˜¯è¿æ¥è¢«æ‹’ç»é”™è¯¯ï¼Œå°è¯•å›é€€åˆ°äº‘ç«¯é…ç½®
                                // æ ‡è®°è¿æ¥å¤±è´¥
                                window._LAST_CONNECTION_FAILED = true;
                                console.log('âš ï¸ ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå°è¯•å›é€€åˆ°äº‘ç«¯AIæœåŠ¡');
                                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº‘ç«¯é…ç½®
                                if (window.AI_CONFIG && window.AI_CONFIG.baseURL) {
                                    console.log('ğŸ”„ åˆ‡æ¢åˆ°äº‘ç«¯AIæœåŠ¡');
                                    callApiViaXmlHttpRequest(window.AI_CONFIG, 
                                        window.AI_CONFIG.baseURL + '/chat/completions', 
                                        method, data, onSuccess, onError);
                                } else {
                                    console.log('âš ï¸ ç½‘ç»œè¿æ¥é—®é¢˜ï¼ŒAIåŠ©æ‰‹éœ€è¦ä¸€äº›æ—¶é—´å“åº”');
                                    onError(new Error(`ç½‘ç»œè¿æ¥é—®é¢˜ (${xhr.status})`));
                                }
                            } else {
                                console.log('âš ï¸ ç½‘ç»œè¯·æ±‚å¤±è´¥:', xhr.status, xhr.statusText);
                                onError(new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ (${xhr.status})`));
                            }
                        }
                    }
                };
                
                xhr.onerror = function() {
                    // é’ˆå¯¹é˜¿é‡Œäº‘APIçš„é”™è¯¯å¤„ç†
                    if (apiUrl.includes('dashscope.aliyuncs.com')) {
                        // å®Œå…¨é™é»˜å¤„ç†CORSé”™è¯¯ï¼Œä¸åœ¨æ§åˆ¶å°è¾“å‡ºæ•æ„Ÿä¿¡æ¯
                        onError(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥')); 
                    } else {
                        // æ ‡è®°è¿æ¥å¤±è´¥
                        window._LAST_CONNECTION_FAILED = true;
                        console.log('âš ï¸ ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå°è¯•å›é€€');
                        if (window.AI_CONFIG && window.AI_CONFIG.baseURL) {
                            callApiViaXmlHttpRequest(window.AI_CONFIG, 
                                window.AI_CONFIG.baseURL + '/chat/completions', 
                                method, data, onSuccess, onError);
                        } else {
                            onError(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥')); 
                        }
                    }
                };
                
                xhr.ontimeout = function() {
                    console.error('âŒ XMLHttpRequestè¯·æ±‚è¶…æ—¶');
                    onError(new Error('è¯·æ±‚è¶…æ—¶')); 
                };
                
                // å‘é€è¯·æ±‚
                if (data) {
                    xhr.send(JSON.stringify(data));
                } else {
                    xhr.send();
                }
                
            } catch (error) {
                console.error('âŒ XMLHttpRequeståˆ›å»ºå¤±è´¥:', error);
                onError(new Error('XMLHttpRequeståˆ›å»ºå¤±è´¥: ' + error.message));
            }
        }
        
        // è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
        function getModels() {
            addMessage('ai', 'è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨ä¸­...', true);
            
            callApi(
                '/v1/models',
                'GET',
                null,
                function(response) {
                    // ç§»é™¤æ€è€ƒæ¶ˆæ¯
                    const messages = chatBody.getElementsByClassName('thinking');
                    if (messages.length > 0) {
                        chatBody.removeChild(messages[messages.length - 1]);
                    }
                    
                    if (response.data && Array.isArray(response.data)) {
                        let modelsList = 'å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼š\n';
                        response.data.forEach(model => {
                            modelsList += `- ${model.id}\n`;
                        });
                        addMessage('ai', modelsList);
                    } else {
                        addMessage('ai', 'è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼šå“åº”æ ¼å¼ä¸æ­£ç¡®');
                    }
                },
                function(error) {
                    // ç§»é™¤æ€è€ƒæ¶ˆæ¯
                    const messages = chatBody.getElementsByClassName('thinking');
                    if (messages.length > 0) {
                        chatBody.removeChild(messages[messages.length - 1]);
                    }
                    addMessage('ai', error.message);
                }
            );
        }
        
        // ä¸Šä¼ å¼•ç”¨çš„å·¥ä½œç°¿æ–‡ä»¶
        function uploadReferencedWorkbook() {
            return new Promise((resolve, reject) => {
                if (!referencedWorkbook) {
                    resolve();
                    return;
                }
                
                addMessage('ai', `æ­£åœ¨ä¸Šä¼ å·¥ä½œç°¿ï¼š${referencedWorkbook}...`);
                
                // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¿‡ç¨‹
                // å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨WPS APIè·å–å·¥ä½œç°¿å†…å®¹å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨
                setTimeout(() => {
                    addMessage('ai', `å·¥ä½œç°¿ "${referencedWorkbook}" å·²æˆåŠŸä¸Šä¼ åˆ°AIå¤§æ¨¡å‹ï¼`);
                    // æ¸…ç©ºå¼•ç”¨
                    referencedWorkbook = null;
                    resolve();
                }, 2000);
            });
        }

        function sendMessage() {
            const userInput = document.getElementById('userInput');
            var userMessage = userInput.value.trim();
            if (!userMessage) {
                return;
            }
        
            // æ£€æŸ¥ç‰¹æ®Šå‘½ä»¤ï¼ˆåŒ…æ‹¬æ–°çš„æ¨¡å‹å‘½ä»¤ï¼‰
            if (userMessage.startsWith('/models') || userMessage.startsWith('/æ¨¡å‹')) {
                getModels();
                // æ¸…é™¤å¼•ç”¨çŠ¶æ€
                userInput.classList.remove('referenced');
                userInput.placeholder = 'è¾“å…¥é—®é¢˜ï¼ŒAIå°†ä¸ºæ‚¨è§£ç­”...';
                userInput.value = '';
                userInput.focus();
                return;
            }
            
            // å¤„ç†ç‰¹æ®Šå‘½ä»¤ï¼Œä½†ä¿ç•™å¼•ç”¨çŠ¶æ€
            const commandHandled = handleSpecialCommands(userMessage);
            if (commandHandled) {
                // åªæœ‰å½“ä¸æ˜¯/å¼•ç”¨æ–‡ä»¶å‘½ä»¤æ—¶æ‰æ¸…é™¤å¼•ç”¨çŠ¶æ€
                if (userMessage !== '/å¼•ç”¨æ–‡ä»¶' && !userMessage.endsWith('/å¼•ç”¨æ–‡ä»¶')) {
                    userInput.classList.remove('referenced');
                    userInput.placeholder = 'è¾“å…¥é—®é¢˜ï¼ŒAIå°†ä¸ºæ‚¨è§£ç­”...';
                    userInput.value = '';
                } else {
                    // å¯¹äº/å¼•ç”¨æ–‡ä»¶å‘½ä»¤ï¼Œä»…æ¸…ç©ºå€¼ä½†ä¿ç•™å¼•ç”¨çŠ¶æ€
                    userInput.value = '';
                }
                userInput.focus();
                return;
            }
        
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
            addMessage('user', userMessage);
            chatHistory.push({ "role": "user", "content": userMessage });
            
            // å¦‚æœæœ‰ä¸Šä¼ çš„æ–‡ä»¶ï¼Œåœ¨æ¶ˆæ¯ä¸­æ·»åŠ ç›¸å…³ä¿¡æ¯
            if (uploadedFileName && currentEmbeddings) {
                const fileInfoMessage = `[åŸºäºæ–‡ä»¶ "${uploadedFileName}" çš„åµŒå…¥å‘é‡è¿›è¡Œé—®ç­”]`;
                const fileInfoElement = document.createElement('div');
                fileInfoElement.className = 'message user-message';
                fileInfoElement.style.fontSize = '12px';
                fileInfoElement.style.opacity = '0.7';
                fileInfoElement.textContent = fileInfoMessage;
                chatBody.appendChild(fileInfoElement);
                
                // åœ¨æ¶ˆæ¯å†å²ä¸­æ·»åŠ æ–‡ä»¶ä¿¡æ¯
                chatHistory.push({ 
                    "role": "user", 
                    "content": fileInfoMessage,
                    "file_embeddings": currentEmbeddings
                });
            }
            
            // æ¸…é™¤å¼•ç”¨çŠ¶æ€å¹¶é‡ç½®è¾“å…¥æ¡†
            userInput.classList.remove('referenced');
            userInput.placeholder = 'è¾“å…¥é—®é¢˜ï¼ŒAIå°†ä¸ºæ‚¨è§£ç­”...ï¼ˆCtrl+Enteræ¢è¡Œï¼‰';
            userInput.value = '';
            userInput.focus();
            
            // æ¸…é™¤å·¥ä½œç°¿å¼•ç”¨æ ‡ç­¾
            const referenceContainer = document.getElementById('workbookReferenceContainer');
            const referencedWorkbookName = document.getElementById('referencedWorkbookName');
            if (referenceContainer && referenceContainer.style.display !== 'none') {
                referenceContainer.style.display = 'none';
                referencedWorkbookName.textContent = '';
                referencedWorkbook = null; // é‡ç½®å…¨å±€å˜é‡
            }
            
            // å…ˆä¸Šä¼ å¼•ç”¨çš„å·¥ä½œç°¿ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç„¶åå‘é€æ¶ˆæ¯
            uploadReferencedWorkbook().then(() => {
                // æ·»åŠ AIæ€è€ƒçŠ¶æ€
                addMessage('ai', 'æ€è€ƒä¸­...', true);
                
                // å‡†å¤‡è¯·æ±‚ä½“ï¼ˆæ ¹æ®æ˜¯å¦æœ‰embeddingså†³å®šè°ƒç”¨å“ªä¸ªç«¯ç‚¹ï¼‰
                let endpoint = '/v1/chat/completions';
                
                // ä½¿ç”¨é…ç½®ä¸­çš„æ¨¡å‹ï¼Œå¦‚æœæ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨é»˜è®¤æ¨¡å‹
                const currentConfig = window.CURRENT_AI_CONFIG || window.AI_CONFIG || {};
                const modelToUse = currentConfig.modelName || "gpt-3.5-turbo";
                
                let requestBody = {
                    model: modelToUse,
                    messages: chatHistory,
                    max_tokens: Math.min(currentConfig.maxTokens || 1000, 8192), // é˜¿é‡Œäº‘APIæœ€å¤§å€¼ä¸º8192
                    temperature: currentConfig.temperature || 0.7,
                    stream: false
                };
                
                // å¦‚æœç”¨æˆ·è¾“å…¥ä»¥ç‰¹å®šå‰ç¼€å¼€å§‹ï¼Œä½¿ç”¨completionsç«¯ç‚¹
                if (userMessage.startsWith('!completion') || userMessage.startsWith('!è¡¥å…¨')) {
                    endpoint = '/v1/completions';
                    const prompt = userMessage.startsWith('!completion') 
                        ? userMessage.substring('!completion'.length).trim()
                        : userMessage.substring('!è¡¥å…¨'.length).trim();
                    
                    // ä½¿ç”¨é…ç½®ä¸­çš„æ¨¡å‹ï¼Œå¦‚æœæ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨é»˜è®¤æ¨¡å‹
                    const currentConfig = window.CURRENT_AI_CONFIG || window.AI_CONFIG || {};
                    const modelToUse = currentConfig.modelName || "text-davinci-003";
                    
                    requestBody = {
                        model: modelToUse, // ä½¿ç”¨é…ç½®ä¸­çš„æ¨¡å‹
                        prompt: prompt,
                        max_tokens: Math.min(currentConfig.maxTokens || 1000, 8192), // é˜¿é‡Œäº‘APIæœ€å¤§å€¼ä¸º8192
                        temperature: currentConfig.temperature || 0.7
                    };
                }
                
                // å‘é€è¯·æ±‚åˆ°AIæ¨¡å‹
                callApi(
                    endpoint,
                    'POST',
                    requestBody,
                    function(response) {
                        // ç§»é™¤æ€è€ƒæ¶ˆæ¯
                        const messages = chatBody.getElementsByClassName('thinking');
                        if (messages.length > 0) {
                            chatBody.removeChild(messages[messages.length - 1]);
                        }
                                    
                        let aiResponse;
                                    
                        // æ ¹æ®ä¸åŒç«¯ç‚¹å¤„ç†å“åº”
                        if (endpoint === '/v1/chat/completions' && response.choices && response.choices.length > 0) {
                            aiResponse = response.choices[0].message.content;
                                        
                            // è§£æå“åº”å†…å®¹ï¼Œåˆ†ç¦»æ€è€ƒå’Œå®é™…å›å¤
                            const parsed = parseAIResponse(aiResponse);
                                        
                            // å¦‚æœæœ‰æ€è€ƒå†…å®¹ï¼Œæ˜¾ç¤ºæ€è€ƒæ¶ˆæ¯
                            if (parsed.thinking) {
                                addThinkingMessage(parsed.thinking);
                            }
                                        
                            // æ˜¾ç¤ºå®é™…å›å¤
                            addMessage('ai', parsed.reply);
                            chatHistory.push({ "role": "assistant", "content": parsed.reply });
                        } 
                        else if (endpoint === '/v1/completions' && response.choices && response.choices.length > 0) {
                            aiResponse = response.choices[0].text;
                            addMessage('ai', aiResponse);
                            // å¯¹äºcompletionsï¼Œä¹Ÿå°†å…¶ä½œä¸ºassistantæ¶ˆæ¯æ·»åŠ åˆ°å†å²
                            chatHistory.push({ "role": "assistant", "content": aiResponse });
                        }
                        else {
                            addMessage('ai', 'æœªæ”¶åˆ°æœ‰æ•ˆå“åº”');
                        }
                    },
                    function(error) {
                        // ç§»é™¤æ€è€ƒæ¶ˆæ¯
                        const messages = chatBody.getElementsByClassName('thinking');
                        if (messages.length > 0) {
                            chatBody.removeChild(messages[messages.length - 1]);
                        }
                                    
                        // é’ˆå¯¹å¸¸è§çš„CORSå’Œç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
                        if (error.message.includes('CORS') || error.message.includes('ç½‘ç»œé”™è¯¯') || error.message.includes('é˜¿é‡Œäº‘API')) {
                            // ä¸æ˜¾ç¤ºä»»ä½•é”™è¯¯ä¿¡æ¯åˆ°UIï¼Œä¹Ÿä¸åœ¨æ§åˆ¶å°è¾“å‡ºæ•æ„Ÿä¿¡æ¯
                            // ä»…æ˜¾ç¤ºå‹å¥½çš„æç¤º
                            addMessage('ai', 'æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚ï¼Œè¯·ç¨å€™...');
                        } else {
                            addMessage('ai', error.message);
                        }
                    }
                );
            });
        }
            


        // stopStreamå‡½æ•°å·²ç§»é™¤ï¼Œå› ä¸ºä¸å†éœ€è¦å¤„ç†æµå¼å“åº”

        function addMessage(role, content, temporary) {
            temporary = temporary || false;
            var messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + role + '-message';
            messageDiv.textContent = content;

            if (temporary) {
                var lastMessage = chatBody.lastChild;
                if (lastMessage && lastMessage.className && lastMessage.className.indexOf('ai-message') !== -1) {
                    chatBody.removeChild(lastMessage);
                }
            }

            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
            return messageDiv;
        }

        function addThinkingMessage(content) {
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'thinking';

            const header = document.createElement('div');
            header.className = 'thinking-header';
            header.innerHTML = 'æ€è€ƒï¼š<span style="font-size:12px; color:#666;">(ç‚¹å‡»å±•å¼€)</span>';
            header.onclick = () => {
                const contentDiv = thinkingDiv.querySelector('.thinking-content');
                contentDiv.style.display = contentDiv.style.display === 'block' ? 'none' : 'block';
                header.querySelector('span').textContent = contentDiv.style.display === 'block' ? '(ç‚¹å‡»æ”¶èµ·)' : '(ç‚¹å‡»å±•å¼€)';
            };

            const thinkingContent = document.createElement('div');
            thinkingContent.className = 'thinking-content';
            thinkingContent.textContent = content;

            thinkingDiv.appendChild(header);
            thinkingDiv.appendChild(thinkingContent);

            chatBody.appendChild(thinkingDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function resetChat() {
            chatBody.innerHTML = '';
            chatHistory = [{ "role": "system", "content": "Always answer in Chinese." }];
            addMessage('ai', 'èŠå¤©å·²é‡æ–°å¼€å§‹ï¼Œè¯·è¾“å…¥æ‚¨çš„é—®é¢˜ã€‚');
        }

        // æ–°å¯¹è¯åŠŸèƒ½ - æ¸…ç©ºèŠå¤©å†å²å’ŒèŠå¤©å†…å®¹
        function clearChatHistory() {
            const chatBody = document.getElementById('chatBody');
            chatBody.innerHTML = '';
            chatHistory = [{ "role": "system", "content": "Always answer in Chinese." }];
            addMessage('ai', 'èŠå¤©å·²é‡æ–°å¼€å§‹ï¼Œè¯·è¾“å…¥æ‚¨çš„é—®é¢˜ã€‚');
        }

        function updateSendButton() {
            const button = document.getElementById('sendButton');
            button.innerHTML = '<span class="icon">â†’</span>';
            button.onclick = sendMessage;
            button.classList.remove('stop-icon');
            button.classList.add('send-icon');
        }

        function parseAIResponse(response) {
            // å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… <think> æ ‡ç­¾
            const thinkClosedRegex = /<think>([\s\S]*?)<\/think>/g; // åŒ¹é…é—­åˆçš„ <think> æ ‡ç­¾
            const thinkOpenRegex = /^<think>([\s\S]*)/; // åŒ¹é…æœªé—­åˆçš„ <think> æ ‡ç­¾

            let thinking = null;
            let reply = response;

            // ä¼˜å…ˆå°è¯•åŒ¹é…é—­åˆçš„ <think> æ ‡ç­¾
            const closedMatches = [...response.matchAll(thinkClosedRegex)];
            if (closedMatches.length > 0) {
                // æå–æ‰€æœ‰é—­åˆçš„ <think> æ ‡ç­¾å†…å®¹
                closedMatches.forEach(match => {
                    thinking = (thinking ? thinking + '\n' : '') + match[1].trim();
                });

                // ç§»é™¤æ‰€æœ‰çš„ <think> æ ‡ç­¾åŠå…¶å†…å®¹
                reply = response.replace(thinkClosedRegex, '').trim();
            } else {
                // å¦‚æœæ²¡æœ‰é—­åˆçš„ <think>ï¼Œå°è¯•åŒ¹é…æœªé—­åˆçš„ <think>
                const openMatch = response.match(thinkOpenRegex);
                if (openMatch) {
                    // å¦‚æœæ˜¯æœªé—­åˆçš„ <think>ï¼Œç›´æ¥å°†å‰©ä½™å†…å®¹ä½œä¸ºå›å¤
                    reply = openMatch[1].trim(); // æå–æœªé—­åˆæ ‡ç­¾åé¢çš„å†…å®¹
                    thinking = null; // å¿½ç•¥æ€è€ƒéƒ¨åˆ†
                }
            }

            return { thinking, reply };
        }

        // åˆ é™¤å·¥ä½œç°¿å¼•ç”¨æ ‡ç­¾
        function removeWorkbookReference() {
            const referenceContainer = document.getElementById('workbookReferenceContainer');
            const referencedWorkbookName = document.getElementById('referencedWorkbookName');
            
            if (referenceContainer && referenceContainer.style.display !== 'none') {
                referenceContainer.style.display = 'none';
                referencedWorkbookName.textContent = '';
                referencedWorkbook = null; // é‡ç½®å…¨å±€å˜é‡
                
                // ç§»é™¤inputçš„å¼•ç”¨çŠ¶æ€æ ·å¼
                userInput.classList.remove('referenced');
                userInput.placeholder = 'è¾“å…¥é—®é¢˜ï¼ŒAIå°†ä¸ºæ‚¨è§£ç­”...ï¼ˆCtrl+Enteræ¢è¡Œï¼‰';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–textareaäº‹ä»¶
        window.onload = function() {
            // åˆå§‹åŒ–textareaäº‹ä»¶ç›‘å¬
            initializeTextareaEvents();
            
            // ç¡®ä¿é…ç½®å·²åŠ è½½
            setTimeout(function() {
                const currentConfig = window.CURRENT_AI_CONFIG || window.AI_CONFIG;
                if (!currentConfig) {
                    addMessage('ai', 'âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°AIé…ç½®ï¼Œè¯·æ£€æŸ¥server-config.txtæ–‡ä»¶æ˜¯å¦æ­£ç¡®é…ç½®');
                } else {
                    console.log('âœ… AIé…ç½®åŠ è½½æˆåŠŸ:', currentConfig.modelName || 'æœªæŒ‡å®šæ¨¡å‹');
                }
            }, 1000);
        };
    </script>
</body>
</html>