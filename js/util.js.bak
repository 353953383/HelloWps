//åœ¨åç»­çš„wpsç‰ˆæœ¬ä¸­ï¼Œwpsçš„æ‰€æœ‰æšä¸¾å€¼éƒ½ä¼šé€šè¿‡wps.Enumå¯¹è±¡æ¥è‡ªåŠ¨æ”¯æŒï¼Œç°é˜¶æ®µå…ˆäººå·¥å®šä¹‰
var WPS_Enum = {
    msoCTPDockPositionLeft:0,
    msoCTPDockPositionRight:2
}

//ä»é…ç½®æ–‡ä»¶è¯»å–æœåŠ¡å™¨é…ç½® - ç»Ÿä¸€è¯»å–index.htmlé…ç½®
function loadServerConfig() {
    return new Promise((resolve, reject) => {
        try {
            const xhr = new XMLHttpRequest();
            // å°è¯•ä»å¤šä¸ªè·¯å¾„åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä»¥è§£å†³404é—®é¢˜
            const configPaths = [
                './server-config.txt',
                '../server-config.txt',
                '/server-config.txt',
                'server-config.txt'
            ];
            
            let currentPathIndex = 0;
            
            function tryLoadPath() {
                if (currentPathIndex >= configPaths.length) {
                    reject(new Error('æ— æ³•ä»ä»»ä½•è·¯å¾„åŠ è½½é…ç½®æ–‡ä»¶: ./server-config.txt, ../server-config.txt, /server-config.txt, server-config.txt'));
                    return;
                }
                
                const currentPath = configPaths[currentPathIndex];
                console.log(`å°è¯•ä»è·¯å¾„åŠ è½½é…ç½®: ${currentPath}`);
                
                xhr.open('GET', currentPath, true);
                xhr.timeout = 10000; // 10ç§’è¶…æ—¶
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200 || xhr.status === 0) { // çŠ¶æ€ç 0è¡¨ç¤ºæœ¬åœ°æ–‡ä»¶è®¿é—®
                            try {
                                const configText = xhr.responseText;
                                console.log('ğŸ“„ é…ç½®æ–‡ä»¶å†…å®¹:', configText);
                                
                                if (configText) {
                                    var config = {};
                                    
                                    // è§£æé…ç½®æ–‡ä»¶
                                    var lines = configText.split('\n');
                                    for (var j = 0; j < lines.length; j++) {
                                        var line = lines[j].trim();
                                        if (line && line.indexOf('=') > 0) {
                                            var parts = line.split('=');
                                            // å¤„ç†åµŒå¥—å¯¹è±¡å±æ€§ (å¦‚ AI_CONFIG.apiKey)
                                            if (parts[0].includes('.')) {
                                                const keyParts = parts[0].split('.');
                                                let obj = config;
                                                for (let i = 0; i < keyParts.length - 1; i++) {
                                                    if (!obj[keyParts[i]]) {
                                                        obj[keyParts[i]] = {};
                                                    }
                                                    obj = obj[keyParts[i]];
                                                }
                                                // ç‰¹æ®Šå¤„ç†æ•°å­—å’Œå¸ƒå°”å€¼
                                                const trimmedValue = parts[1].trim();
                                                if (!isNaN(trimmedValue) && trimmedValue !== '') {
                                                    obj[keyParts[keyParts.length - 1]] = Number(trimmedValue);
                                                } else if (trimmedValue === 'true' || trimmedValue === 'false') {
                                                    obj[keyParts[keyParts.length - 1]] = trimmedValue === 'true';
                                                } else {
                                                    obj[keyParts[keyParts.length - 1]] = trimmedValue;
                                                }
                                            } else {
                                                // ç‰¹æ®Šå¤„ç†æ•°å­—å’Œå¸ƒå°”å€¼
                                                const trimmedValue = parts[1].trim();
                                                if (!isNaN(trimmedValue) && trimmedValue !== '') {
                                                    config[parts[0]] = Number(trimmedValue);
                                                } else if (trimmedValue === 'true' || trimmedValue === 'false') {
                                                    config[parts[0]] = trimmedValue === 'true';
                                                } else {
                                                    config[parts[0]] = trimmedValue;
                                                }
                                            }
                                        }
                                    }
                                    
                                    console.log('âš™ï¸ è§£æåçš„é…ç½®å¯¹è±¡:', config);
                                    
                                    // ä¸å†éªŒè¯PRODUCTIONå­—æ®µï¼Œç›´æ¥resolveé…ç½®å¯¹è±¡
                                    resolve(config);
                                } else {
                                    reject(new Error('é…ç½®æ–‡ä»¶ä¸ºç©º'));
                                }
                            } catch (parseError) {
                                reject(parseError);
                            }
                        } else {
                            console.warn(`è·¯å¾„ ${currentPath} åŠ è½½å¤±è´¥ï¼ŒçŠ¶æ€ç : ${xhr.status}ï¼Œå°è¯•ä¸‹ä¸€ä¸ªè·¯å¾„...`);
                            currentPathIndex++;
                            tryLoadPath();
                        }
                    }
                };
                xhr.onerror = function() {
                    console.warn(`è·¯å¾„ ${currentPath} ç½‘ç»œé”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªè·¯å¾„...`);
                    currentPathIndex++;
                    tryLoadPath();
                };
                xhr.ontimeout = function() {
                    console.warn(`è·¯å¾„ ${currentPath} åŠ è½½è¶…æ—¶ï¼Œå°è¯•ä¸‹ä¸€ä¸ªè·¯å¾„...`);
                    currentPathIndex++;
                    tryLoadPath();
                };
                xhr.send();
            }
            
            tryLoadPath();
        } catch (e) {
            // é…ç½®è¯»å–å¤±è´¥ï¼Œè®°å½•é”™è¯¯
            if (typeof console !== 'undefined' && console.error) {
                console.error('âŒ ä¸¥é‡é”™è¯¯ï¼šæ— æ³•åŠ è½½å¤–éƒ¨é…ç½®æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ server-config.txt æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®:', e);
            }
            reject(new Error('é…ç½®åŠ è½½å¤±è´¥ï¼Œç³»ç»Ÿæ— æ³•å¯åŠ¨'));
        }
    });
}

// ç»Ÿä¸€é…ç½®ç®¡ç†
(function() {
    try {
        // åŠ è½½é…ç½®
        var configResult = null;
        try {
            loadServerConfig().then(function(result) {
                configResult = result;
                if (configResult) {
                    // å°†é…ç½®æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
                    window.CONFIG = configResult;
                    window.SERVER_CONFIG = configResult.PRODUCTION;
                    window.PRODUCTION = configResult.PRODUCTION;
                    window.AI_CONFIG_TYPE = configResult.AI_CONFIG_TYPE;
                    window.AI_CONFIG = configResult.AI_CONFIG;
                    window.AI_CONFIG_WLAN = configResult.AI_CONFIG_WLAN;
                    
                    // æ ¹æ®é…ç½®ç±»å‹è®¾ç½®å½“å‰ä½¿ç”¨çš„AIé…ç½®
                    if (configResult.AI_CONFIG_TYPE === 'AI_CONFIG_WLAN' && configResult.AI_CONFIG_WLAN) {
                        window.CURRENT_AI_CONFIG = configResult.AI_CONFIG_WLAN;
                        console.log('âœ… ä½¿ç”¨å±€åŸŸç½‘AIé…ç½®');
                    } else if (configResult.AI_CONFIG_TYPE === 'AI_CONFIG' && configResult.AI_CONFIG) {
                        window.CURRENT_AI_CONFIG = configResult.AI_CONFIG;
                        console.log('âœ… ä½¿ç”¨äº‘ç«¯AIé…ç½®');
                    } else if (configResult.AI_CONFIG_WLAN) {
                        // å¦‚æœæ²¡æœ‰è®¾ç½®ç±»å‹ä½†æœ‰å±€åŸŸç½‘é…ç½®ï¼Œåˆ™ä½¿ç”¨å±€åŸŸç½‘é…ç½®
                        window.CURRENT_AI_CONFIG = configResult.AI_CONFIG_WLAN;
                        window.AI_CONFIG_TYPE = 'AI_CONFIG_WLAN';
                        console.log('âœ… é»˜è®¤ä½¿ç”¨å±€åŸŸç½‘AIé…ç½®');
                    } else if (configResult.AI_CONFIG) {
                        // å¦‚æœæ²¡æœ‰è®¾ç½®ç±»å‹ä½†æœ‰äº‘ç«¯é…ç½®ï¼Œåˆ™ä½¿ç”¨äº‘ç«¯é…ç½®
                        window.CURRENT_AI_CONFIG = configResult.AI_CONFIG;
                        window.AI_CONFIG_TYPE = 'AI_CONFIG';
                        console.log('âœ… é»˜è®¤ä½¿ç”¨äº‘ç«¯AIé…ç½®');
                    } else {
                        console.error('âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„AIé…ç½®');
                        throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„AIé…ç½®');
                    }
                    
                    console.log('âœ… é…ç½®åŠ è½½æˆåŠŸ:', configResult);
                } else {
                    throw new Error('é…ç½®åŠ è½½è¿”å›ç©ºç»“æœ');
                }
            }).catch(function(error) {
                console.error('é…ç½®åŠ è½½å¤±è´¥:', error);
                applyFallbackConfig();
            });
        } catch (loadError) {
            console.error('é…ç½®åŠ è½½å¤±è´¥:', loadError);
            applyFallbackConfig();
        }
        
    } catch (e) {
        console.error('é…ç½®åˆå§‹åŒ–å¤±è´¥:', e);
        applyFallbackConfig();
    }
    
    function applyFallbackConfig() {
        // æ·»åŠ åº”æ€¥é…ç½®ä»¥é˜²ç³»ç»Ÿæ— æ³•å¯åŠ¨
        window.PRODUCTION = 'http://192.168.70.26:8080/V6R343/';
        window.SERVER_CONFIG = 'http://192.168.70.26:8080/V6R343/';
        window.AI_CONFIG = {
            apiKey: 'sk-9bacbdffb7dd4b91b240c472d9c5e0c2',
            baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
            modelName: 'qwen-max',
            maxTokens: 30000,
            temperature: 0.3,
            timeout: 60000,
            description: 'é˜¿é‡Œäº‘ç™¾ç‚¼OpenAIæ ¼å¼APIï¼ˆé€šè¿‡OpenAIå®¢æˆ·ç«¯è°ƒç”¨ï¼‰'
        };
        window.AI_CONFIG_WLAN = {
            apiEndpoint: 'http://192.168.70.26:1234/v1/chat/completions',
            modelName: 'local-model',
            apiKey: 'local-api-key',
            maxTokens: 30000,
            temperature: 0.3,
            timeout: 300000,
            requestFormat: 'compatible',
            description: 'å±€åŸŸç½‘éƒ¨ç½²çš„AIæ¨¡å‹'
        };
        // æ ¹æ®é…ç½®ç±»å‹å†³å®šä½¿ç”¨å“ªä¸ªé…ç½®
        if (window.AI_CONFIG_TYPE === 'AI_CONFIG_WLAN') {
            window.CURRENT_AI_CONFIG = window.AI_CONFIG_WLAN;
            console.log('âœ… ä½¿ç”¨åº”æ€¥å±€åŸŸç½‘AIé…ç½®');
        } else {
            window.CURRENT_AI_CONFIG = window.AI_CONFIG;
            console.log('âœ… ä½¿ç”¨åº”æ€¥äº‘ç«¯AIé…ç½®');
        }
        console.warn('âš ï¸ é…ç½®åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨åº”æ€¥é…ç½®');
    }
})();